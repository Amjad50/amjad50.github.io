<!doctype html><html lang=ar dir=rtl><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>نظام التشغيل - القفل الدوراني | أمجد الشرفي</title>
<meta name=keywords content="نظام تشغيل,rust,قفل"><meta name=description content="الحديث عن تنفيذ القفل الدوراني بشكل آمن باستخدام لغة Rust في نظام تشغيل"><meta name=author content="أمجد"><link rel=canonical href=https://amjad.alsharafi.dev/ar/posts/operating-system/spinlocks/><link crossorigin=anonymous href=/assets/css/stylesheet.fb6b2b389d367570c345e9a7d7aeabb04679403de8a4f329d93b470de0d59c79.css integrity="sha256-+2srOJ02dXDDRemn166rsEZ5QD3opPMp2TtHDeDVnHk=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://amjad.alsharafi.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://amjad.alsharafi.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://amjad.alsharafi.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://amjad.alsharafi.dev/apple-touch-icon.png><link rel=mask-icon href=https://amjad.alsharafi.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://amjad.alsharafi.dev/en/posts/operating-system/spinlocks/><link rel=alternate hreflang=ar href=https://amjad.alsharafi.dev/ar/posts/operating-system/spinlocks/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-N62ZER16LZ"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-N62ZER16LZ",{anonymize_ip:!1})}</script><meta property="og:title" content="نظام التشغيل - القفل الدوراني"><meta property="og:description" content="الحديث عن تنفيذ القفل الدوراني بشكل آمن باستخدام لغة Rust في نظام تشغيل"><meta property="og:type" content="article"><meta property="og:url" content="https://amjad.alsharafi.dev/ar/posts/operating-system/spinlocks/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-03T05:00:00+08:00"><meta property="article:modified_time" content="2023-12-05T09:00:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="نظام التشغيل - القفل الدوراني"><meta name=twitter:description content="الحديث عن تنفيذ القفل الدوراني بشكل آمن باستخدام لغة Rust في نظام تشغيل"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":4,"name":"نظام التشغيل - القفل الدوراني","item":"https://amjad.alsharafi.dev/ar/posts/operating-system/spinlocks/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"نظام التشغيل - القفل الدوراني","name":"نظام التشغيل - القفل الدوراني","description":"الحديث عن تنفيذ القفل الدوراني بشكل آمن باستخدام لغة Rust في نظام تشغيل","keywords":["نظام تشغيل","rust","قفل"],"articleBody":"مؤخرًا، كنت أعمل على نظام تشغيل صغير باستخدام لغة البرمجة Rust (هنا OS). أحد أهدافي في هذا المشروع هو بناء أكبر قدر ممكن من المكونات من الصفر (في وقت الكتابة، لا توجد تبعيات). بالطبع، ليس عليك القيام بذلك، ولكن أعتقد أن هذه فرصة جيدة للتعلم.\nعلى أي حال، إحدى الأشياء المهمة في نظام التشغيل هي التزامن، حيث إن معظم الموارد في النظام تكون مشتركة بين عدة أنوية. لذا نحن بحاجة للتأكد من أنه يمكن لنواة واحدة فقط الوصول إلى مورد في وقت واحد، وهنا تأتي الأقفال لتلعب دورها.\nعلى الرغم من أنني أقول “أنظمة التشغيل” هنا، إلا أن هذا النوع من القفل يُستخدم في أي تطبيق بدون نظام تشغيل، مثل الأنظمة المضمنة، أو حتى في تطبيقات مساحة المستخدم.\nأستخدم Rust هنا للتنفيذ، ولكن هذا ليس منشورًا محددًا للغة Rust، يمكنك تنفيذه في أي لغة ترغب فيها، الفكرة هي نفسها.\nما هو القفل؟ القفل هو أساس تزامن يسمح فقط لنواة أو معالج واحد بالوصول إلى مورد في وقت واحد. عندما تحاول نواة أو معالج آخر الوصول إلى المورد، سيتم حجبه حتى تقوم النواة أو معالج الأول بإطلاق القفل، وبالتالي، يمكننا التأكد من أنه يوجد فقط نواة أو معالج واحد يمكنه الوصول إلى المورد في وقت واحد.\nكيف تستخدم الprocess الأقفال داخل نظام التشغيل؟ في داخل نظام تشغيل عادي، تعمل الprocess بتشغيل عدة خيوط، ويدير النظام التشغيل هذه الخيوط. كما يوفر لك النظام التشغيل وسيلة لإنشاء آلية قفل بين خيوطك.\nعلى سبيل المثال، في نظام Linux، يمكنك استخدام وظائف pthread_mutex_lock/unlock لقفل/فتح كائن القفل المتزامن. القفل هنا هو أساس تزامن يسمح فقط لخيط واحد بالوصول إلى مورد في وقت واحد، وهكذا يمكنك مزامنة خيوطك.\nفي نظام Windows، يمكنك استخدام وظائف AcquireSRWLockExclusive/ReleaseSRWLockExclusive لقفل/فتح كائن SRW Lock.\nإذاً، إنها واجهة برمجة التطبيقات التي يوفرها نظام التشغيل للسماح بتزامن فعّال بين الخيوط. عندما يكون الخيط في انتظار القفل، يدخل في حالة انتظار، وبالتالي لا يستهلك الكثير من وحدات المعالجة المركزية.\nكيف يمكننا صناعة أقفال خاصة بنا في نظام التشغيل؟ داخل النواة، ليس لدينا نظام تشغيل رئيسي يقدم لنا آلية إقفال، لذا يجب أن نقوم بتنفيذها بأنفسنا بطريقة ما.\nوهنا يأتي القفل الدوراني، القفل الدوراني هو قفل ينتظر بشكل نشط حتى يتاح الوصول إليه. لذا، إذا كان هناك نواتين، وإحدى النواتين تحمل القفل، ستبقى النواة الأخرى في حلقة تنتظر حتى يتاح فتح القفل، ثم تقوم بالحصول عليه.\nعمل قفل دوراني حسنًا، لدينا الفكرة الأولى في عقولنا الآن، دعونا نقوم بتنفيذها.\nلنفترض أن لدينا دالة بإسم handle_resource تقوم بتنفيذ بعض الإجراءات على مورد مشترك، ونريد التأكد من أنه يمكن لنواة واحدة فقط الوصول إلى المورد في وقت واحد، لذا سنستخدم دالة القفل الدوراني لذلك.\nسيكون المورد في متغير ثابت static، نظرًا لأننا نريد الوصول إليه من أي مكان. سنقوم بتنفيذ القفل في عدة تحديثات ونشرح المشكلة مع كل واحدة.\nالإصدار الأول 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 struct Spinlock { locked: bool, } impl Spinlock { fn new() -\u003e Self { Self { locked: false, } } fn lock(\u0026mut self) { while self.locked { // spin } self.locked = true; } fn unlock(\u0026mut self) { self.locked = false; } } static mut GLOBAL_LOCK: Spinlock = Spinlock::new(); static mut GLOBAL_RESOURCE: u32 = 0; // this will be called from multiple cores fn kernel_main() { unsafe { // SAFETY: is this safe? GLOBAL_LOCK.lock(); // SAFETY: we know that we are the only core accessing this resource // so its safe to access it GLOBAL_RESOURCE += 1; GLOBAL_LOCK.unlock(); } } هنا، قمنا بتنفيذ قفل دوراني باستخدام متغير bool. لدينا دالة lock التي تنتظر بشكل نشط حتى يتاح الوصول إلى القفل، ثم نقوم بتعيين متغير locked إلى true. ولدينا أيضًا دالة unlock التي تقوم بتعيين متغير locked إلى false.\nلكن هناك مشكلة كبيرة، هناك فجوة بين حلقة while وتعيين متغير locked إلى true، وفي هذه الفجوة، يمكن لنواة أخرى أن تأخذ القفل ولكننا لن نعلم عنها، وبالتالي، سيكون لدينا نواتين تصل إلى المورد في نفس الوقت.\nعرض المشكلة في رسم توضيحي:\nCore1: lock() - Core1: self.locked == false // `غير مقفل، قم بتعيينه إلى `صحيح Core2: lock() - Core2: self.locked == false // `غير مقفل، قم بتعيينه إلى `صحيح - Core1: self.locked = true - Core2: self.locked = true // الآن لديهم النواتين القفل لنحاول حل هذه المشكلة.\nالإصدار الثاني 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 use core::sync::atomic::{AtomicBool, Ordering}; struct Spinlock { locked: AtomicBool, } impl Spinlock { fn new() -\u003e Self { Self { locked: AtomicBool::new(false), } } fn lock(\u0026self) { while self.locked.compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed).is_err() { // spin } } fn unlock(\u0026self) { self.locked.store(false, Ordering::Release); } } static GLOBAL_LOCK: Spinlock = Spinlock::new(); static mut GLOBAL_RESOURCE: u32 = 0; // this will be called from multiple cores fn kernel_main() { GLOBAL_LOCK.lock(); unsafe { // SAFETY: we know that we are the only core accessing this resource // so its safe to access it GLOBAL_RESOURCE += 1; } GLOBAL_LOCK.unlock(); } إذا، هنا نستخدم AtomicBool بدلاً من bool العادي، ونستخدم compare_exchange لتعيين المتغير locked إلى true بطريقة ما؟ أيضًا إذا لاحظت، فإن القفل الآن ليس mut، ونحن نستخدم self\u0026 بدلاً من mut self\u0026، وبالتالي يُسمح لنا باستخدامه من static بدون أي unsafe.\nولكن كيف يعمل ذلك؟\nAtomicBool هو قيمة منطقية يمكن الوصول إليها بشكل ذري، وهذا يعني أن كل عملية تتم على هذا النوع تتم ذريًا، أي أن العملية كلها تتم كوحدة واحدة، وبالتالي، لا يمكن لنواة أخرى الوصول إلى المتغير في منتصف العملية.\nدالة compare_exchange هي عملية ذرية تقارن قيمة المتغير بالقيمة الأولى، وإذا كانت متساوية، يتم تعيين قيمة المتغير إلى القيمة الثانية ذريًا، لا يمكن لنواتان أن تعينان القيمة في نفس الوقت، ستفوز نواة واحدة فقط في السباق. ثم تعيد الدالة Ok إذا كانت العملية ناجحة، و Err في غير ذلك (يرجى الرجوع إلى الdocs للمزيد من المعلومات).\nبسبب كيفية عمل العمليات الذرية، يمكن لراست جعل الدوال تستخدم \u0026self بدلاً من \u0026mut self، لأنها يمكنها ضمان أن لا نواة أخرى يمكنها الوصول إلى المتغير في نفس الوقت. وبالتالي يمكننا تقليل الكود غير الآمن.\nشيء آخر يجب ملاحظته هو Ordering، يُحدد للمعالج كيف يمكنه ترتيب العمليات في الذاكرة المتعلقة بالعملية التزامنية، وكيف يؤثر على عمليات الذاكرة الأخرى حول العملية الذرية.\nلشرح بسيط جدًا، Ordering::Acquire سيضمن أن جميع عمليات الذاكرة قبل العملية الذرية ستظهر للنواة الأخرى، و Ordering::Release سيضمن أن جميع عمليات الذاكرة بعد العملية الذرية ستظهر للنواة الأخرى.\nOrdering::Relaxed هو الترتيب الأضعف، ولا يضمن أي شيء على العمليات الأخرى، ولكنه فقط يضمن أن الذاكرة الملامسة بواسطة العملية الذرية ستظهر للنواة الأخرى (للمزيد من المعلومات حول هذا انظر إلى الdocs أو Book: Rust Atomics and Locks).\nإذاً، عظيم، حلنا المشكلة، صحيح؟ حسنًا، نعم، ولكن هناك مشكلة أخرى.\nهذه المشكلة مختصة فقط بتنفيذ نواة، وهي “المقاطعات”.\nعندما تكون داخل النواة، لا تخاف من النواة الأخرى فقط، ولكنك أيضًا تخاف من نفسك. يمكن أن تجد نفسك وراء ظهرك دون أن تلاحظ D:\nهنا كيف يمكن أن يحدث ذلك.\nCore 1: lock() Core 1: self.locked.compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed) == Ok // ...القفل مغلق الآن، ونحن نقوم بعمل ما هنا، ولم ننتهِ بعد // ... [interrupt] // المقاطعة Core 1: lock() // نفس القفل مرة أخرى. Core 1: while self.locked.compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed) == Err // ....معلق للأبد وهذا، أيها الأصدقاء، يُعرف باسم الانغلاق.\nالانغلاق هو حالة يكون فيها خيط أو النواة في انتظار قفل يمتلكه بالفعل، وبالتالي، لن يكون قادرًا أبدًا على الحصول على القفل.\nإذا، كيف يمكننا حل هذه المشكلة؟\nالإصدار الثالث طريقة واحدة لحل هذه المشكلة هي من خلال منع وحدة المعالجة المركزية من استقبال المقاطعات أثناء الاحتفاظ بالقفل، بحيث لا يتم تشويشنا والوقوع في هذا الوضع.\nهنا، أقوم فقط بتنفيذها لوحدة المعالجة المركزية x86-64، لذا هذا الجزء يعتمد على نوع الوحدة المعالجة المركزية، ولكن الفكرة هي نفسها للوحدات المعالجة المركزية الأخرى باستخدام تعليمات مختلفة.\nلن أكرر الكود القديم الذي لا يتغير\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 struct Cpu { old_interrupt_state: bool, number_pushed: u32, } impl Cpu { fn push_interrupt_disable(\u0026mut self) { if self.number_pushed == 0 { self.old_interrupt_state = cpu_specific::current_interrupt(); cpu_specific::disable_interrupts(); } self.number_pushed += 1; } fn pop_interrupt_disable(\u0026mut self) { self.number_pushed -= 1; if self.number_pushed == 0 { if self.old_interrupt_state { x86_64::instructions::interrupts::enable(); } } } } fn current_cpu() -\u003e \u0026'static mut Cpu { // ... // get a static variable or something // we can use an array hosting all the CPUs structs for example, // and ensuring an index is only usable by one core } impl Spinlock { fn lock(\u0026self) { current_cpu().push_interrupt_disable(); while self.locked.compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed).is_err() { // spin } } fn unlock(\u0026self) { self.locked.store(false, Ordering::Release); current_cpu().pop_interrupt_disable(); } } حسنًا، هذا الكثير من الكود. دعونا نقم بشرحها.\nلذا، كان لدينا خطة لتعطيل المقاطعات. ولكن كيف يمكننا القيام بذلك بشكل آمن.\nإذا قمنا بتنفيذ ()cpu::disable_interrupts بطريقة ساذجة، على سبيل المثال داخل القفل، ثم ()cpu::enable_interrupts داخل الإلغاء، سنواجه مشكلة، حيث ستفشل إذا كانت هناك أقفال متداخلة.\nلنرى.\nCore 1: Lock1::lock() Core 1: cpu::disable_interrupts() Core 1: self.locked.compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed) == Ok // القفل مغلق الآن، ولن نتلقى المقاطعات // ... Core 1: Lock2::lock() Core 1: cpu::disable_interrupts() // منعت بالفعل، ولكن مهما كان الأمر Core 1: self.locked.compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed) == Ok // القفل مغلق الآن، ولن نتلقى المقاطعات // ... Core 1: Lock2::unlock() Core 1: self.locked.store(false, Ordering::Release) Core 1: cpu::enable_interrupts() // المقاطعات مُمكّنة الآن // ... [interrupt]// المقاطعة Core 1: Lock1::lock() // نفس القفل مرة أخرى، وواجهنا نفس المشكلة، حيث قمنا بتمكين المقاطعات في مكان لا ينبغي إذاً، علينا حل هذه المشكلة، يمكن حلها بسهولة عن طريق تذكر كم مرة قمنا بتعطيل المقاطعات، ثم العودة للخلف، وتمكين المقاطعات بعد التأكد من عدم توقع أحد تعطيل المقاطعات.\nالمثال أعلاه سيكون كالتالي مع تنفيذ push_interrupt_disable و pop_interrupt_disable:\nلا نحتاج إلى استخدام atomic عند زيادة number_pushed، لأن خط الإضافة سيُنفذ مرة واحدة فقط عند تعطيل المقاطعات، ويجب أن يكون هذا الهيكل يستخدم فقط من قبل نواة مالكة واحدة، أي أن النوى الأخرى لن تنفذ هذا الشيفرة على الإطلاق (لم يتم تنفيذ هذا هنا، أتركها كتمرين للقارئ).\nCore 1: Lock1::lock() Core 1: push_interrupt_disable() // interrupt=false, number_pushed=1 Core 1: self.locked.compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed) == Ok // القفل مغلق الآن، ولن نتلقى المقاطعات // ... Core 1: Lock2::lock() Core 1: push_interrupt_disable() // interrupt=false, number_pushed=2 Core 1: self.locked.compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed) == Ok // القفل مغلق الآن، ولن نتلقى المقاطعات // ... Core 1: Lock2::unlock() Core 1: self.locked.store(false, Ordering::Release) Core 1: pop_interrupt_disable() // interrupt=false, number_pushed=1 // المقاطعات ما زالت معطلة // ... Core 1: Lock1::unlock() Core 1: self.locked.store(false, Ordering::Release) Core 1: pop_interrupt_disable() // interrupt=true, number_pushed=0 // المقاطعات مُمكّنة الآن وكل شيء آمن ونعم، هذا هو كل شيء، لدينا الآن قفل دوراني يعمل. أعتقد أن هذا آمن من جميع المشاكل التي وجدتها، ولكن إذا وجدت أي مشكلة، فالرجاء إعلامي :)\nجعلها تتناسب مع Rust لدينا قفل الآن، ولكن استخدامه يبدو غير جميل، انظر إلى هذا:\n1 2 3 4 5 6 7 GLOBAL_LOCK.lock(); unsafe { // SAFETY: we know that we are the only core accessing this resource so its safe to access it GLOBAL_RESOURCE += 1; } GLOBAL_LOCK.unlock(); يمكننا تحسين الوضع عن طريق إنشاء نوع يحتوي على البيانات والقفل، ويدير جميع الأمور unsafe بالنيابة عنا حتى لا نضطر إلى القيام بذلك.\nيمكننا الحصول على إلهام من نوع Mutex في المكتبة القياسية.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 use core::{cell::UnsafeCell, ops::{Deref, DerefMut}}; // you can put this in `spin::Mutex` or something struct SpinMutex\u003cT\u003e { lock: Spinlock, data: UnsafeCell\u003cT\u003e, } // impl extra stuff here, like `unsafe Send/Sync`, `Debug`, I won't go into details here impl\u003cT\u003e SpinMutex\u003cT\u003e { fn new(data: T) -\u003e Self { Self { lock: Spinlock::new(), data: UnsafeCell::new(data), } } fn lock(\u0026self) -\u003e SpinMutexGuard\u003c'_, T\u003e { self.lock.lock(); SpinMutexGuard { lock: \u0026self.lock, // SAFETY: we know that we are the only core accessing this resource so its safe to access it data: unsafe { \u0026mut *self.data.get() }, } } // extra function here fn try_lock(\u0026self) -\u003e Option\u003cSpinMutexGuard\u003c'_, T\u003e\u003e { // `try_lock` here just performs `lock` but without looping // it will return `true` if the lock was acquired, and `false` otherwise if self.lock.try_lock() { Some(SpinMutexGuard { lock: \u0026self.lock, data: unsafe { \u0026mut *self.data.get() }, }) } else { None } } fn unlock(\u0026self) { self.lock.unlock(); } } struct SpinMutexGuard\u003c'a, T\u003e { lock: \u0026'a Spinlock, data: \u0026'a mut T, } impl \u003c'a, T\u003e Deref for SpinMutexGuard\u003c'a, T\u003e { type Target = T; fn deref(\u0026self) -\u003e \u0026Self::Target { self.data } } impl \u003c'a, T\u003e DerefMut for SpinMutexGuard\u003c'a, T\u003e { fn deref_mut(\u0026mut self) -\u003e \u0026mut Self::Target { self.data } } impl\u003cT\u003e Drop for SpinMutexGuard\u003c'_, T\u003e { fn drop(\u0026mut self) { self.lock.unlock(); } } // usage static GLOBAL_RESOURCE: SpinMutex\u003cu32\u003e = SpinMutex::new(0); fn kernel_main() { let mut guard = GLOBAL_RESOURCE.lock(); *guard += 1; // guard is dropped here, and the lock is unlocked } هنا، نستخدم UnsafeCell لتخزين البيانات. نقوم بذلك لأننا نرغب في تغيير البيانات حتى إذا كان لدينا وصول مشترك إليها. لذا، يجب أن نخبر المترجم أننا ندرك المخاطر، ولهذا نستخدم unsafe.\nعندما نقوم بقفل الMutex، نحصل على SpinMutexGuard الذي يحتوي على مؤشر إلى البيانات. عندما ينتهي، يقوم بفتح القفل. نظرًا لأنه يحتوي على مؤشر إلى القفل داخليًا، نحن واثقون من عدم إمكانية استخدام نواة أخرى للقفل في نفس الوقت. لذا، يمكننا استخدامه بأمان ثم فتحه.\nSpinMutexGuard ينفذ Deref و DerefMut لتسهيل الوصول إلى البيانات الداخلية. كما ينفذ أيضًا Drop بحيث يتم فتح القفل عندما لا يكون هناك حاجة إليه بعد (مثل عندما يخرج من نطاق الرؤية). يوفر ذلك لنا من الحاجة إلى استدعاء unlock يدويًا (RAII).\nوهذا في الأساس كل شيء، لدينا قفل دوران جيد الآن، ويمكننا استخدامه بسهولة.\nتحسينات صغيرة إضافية شيء آخر تركته للنهاية، حيث لا يؤثر على الوظائف، ولكنه تحسين جميل.\nوهو استخدام core::hint::spin_loop بدلاً من حلقة فارغة، وهذا سيوحي للمترجم/وحدة المعالجة المركزية أننا في حالة تكرار، وبالتالي، يمكنها تحسينها بشكل أفضل.\n1 2 3 4 5 fn lock(\u0026self) { while self.locked.compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed).is_err() { core::hint::spin_loop(); } } شيء آخر (شكرًا لـ zypeh) هو استخدام core::sync::atomic::AtomicUsize بدلاً من core::sync::atomic::AtomicBool، أو باستخدام crossbeam_utils::CachePadded للتأكد من أن القفل ليس في نفس خط التخزين المؤقت للذاكرة الذي يحتوي على متغيرات أخرى. وبذلك، يمكننا تجنب مشكلة التشارك الكاذبة (false sharing)، وتحسين الأداء.\nالمشاكل هذا Mutex الذي لدينا الآن جيد، ولكن هناك عدة قضايا.\nSpin بالطبع، هذا هو قفل دوران، وسيضيع الوقت إذا تم الاحتفاظ بالقفل لفترة طويلة. هناك أنواع أخرى من الأقفال تحاول أن تكون أكثر عدالة، أو تعطي مهمة أخرى للنواة للقيام بها أثناء انتظار القفل. لا أعرف بالضبط، ولكن عندما أقوم بتنفيذ ذلك، سأقوم بإنشاء منشور جديد حوله D:\nAnother type of deadlock تخيل أنك تستخدم قفل داخل نوع Console على سبيل المثال. هذا هو نوع قمت بتنفيذه لطباعة الرسائل على الشاشة/واجهة التسلسل، ستحتاج إلى استخدام قفل هنا بحيث يمكن لنواة واحدة فقط الطباعة في وقت واحد.\nالآن تخيل أن هذا Console يثير استثناء بطريقة ما، ولديك معالج استثناء يقوم بطباعة رسالة الاستثناء. هذا ليس انقطاع تنفيذ لوحدة المعالجة المركزية، ولكنه ميزة في Rust تقوم بنقل التنفيذ إلى panic_handler محدد.\nسيؤدي ذلك إلى إنشاء تأخر تشابكي، حيث سيحاول panic_handler قفل Console لطباعة الرسالة، ولكن Console قد تم قفله بالفعل بواسطة النواة التي أثارت الاستثناء، وبالتالي، سنواجه تأخر تشابكي.\nبالنسبة لهذا، يمكنك الاستفادة من نوع خاص من Mutex يسمح لك بقفله مرة أخرى بواسطة نفس النواة فقط. وهذا النوع من القفل يُستخدم فعلاً في المكتبة القياسية داخليًا، ويُسمى ReentrantMutex. تقوم المكتبة القياسية بتنفيذه مع خيط المالك، ويمكننا ببساطة استبداله بالنواة المالكة .\nولكن بالطبع، يمكن استخدام هذا النوع فقط في الأماكن القليلة التي تنشأ فيها هذه المشكلة، وليس بشكل عام. وعندما تحصل على القفل مرة أخرى، يجب عليك التأكد من أنك لا تسبب أي مشكلات مع البيانات داخليًا. لن يكون هناك مستخدم آخر في نفس الوقت، ولكن الحالة القابلة للتعديل يجب أن تكون دائمًا صالحة.\nتُستخدم هذه في المكتبة القياسية كغلاف لـ stdout و stderr. (مثال: ReentrantMutex","wordCount":"2757","inLanguage":"ar","datePublished":"2023-12-03T05:00:00+08:00","dateModified":"2023-12-05T09:00:00+08:00","author":{"@type":"Person","name":"أمجد"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://amjad.alsharafi.dev/ar/posts/operating-system/spinlocks/"},"publisher":{"@type":"Organization","name":"أمجد الشرفي","logo":{"@type":"ImageObject","url":"https://amjad.alsharafi.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://amjad.alsharafi.dev/ar/ accesskey=h title="أمجد الشرفي (Alt + H)">أمجد الشرفي</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://amjad.alsharafi.dev/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://amjad.alsharafi.dev/ar/about title=عن><span>عن</span></a></li><li><a href=https://amjad.alsharafi.dev/ar/series title=سلاسل><span>سلاسل</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://amjad.alsharafi.dev/ar/>الصفحة الرئيسية</a></div><h1 class=post-title>نظام التشغيل - القفل الدوراني</h1><div class=post-description>الحديث عن تنفيذ القفل الدوراني بشكل آمن باستخدام لغة Rust في نظام تشغيل</div><div class=post-meta><span title='2023-12-03 05:00:00 +0800 +0800'>ديسمبر 3, 2023</span>&nbsp;·&nbsp;دقائق 13&nbsp;·&nbsp;أمجد&nbsp;|&nbsp;ترجمات أخرى:<ul class=i18n_list><li><a href=https://amjad.alsharafi.dev/en/posts/operating-system/spinlocks/>English</a></li></ul>&nbsp;|&nbsp;<a href=https://github.com/Amjad50/amjad50.github.io/tree/master/content/posts/operating%20system/spinlocks/index.ar.md rel="noopener noreferrer" target=_blank>اقترح تعديلات</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>فهرس المحتوى</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#ما-هو-القفل>ما هو القفل؟</a></li><li><a href=#كيف-تستخدم-الprocess-الأقفال-داخل-نظام-التشغيل>كيف تستخدم الprocess الأقفال داخل نظام التشغيل؟</a></li><li><a href=#كيف-يمكننا-صناعة-أقفال-خاصة-بنا-في-نظام-التشغيل>كيف يمكننا صناعة أقفال خاصة بنا في نظام التشغيل؟</a></li><li><a href=#عمل-قفل-دوراني>عمل قفل دوراني</a><ul><li><a href=#الإصدار-الأول>الإصدار الأول</a></li><li><a href=#الإصدار-الثاني>الإصدار الثاني</a></li><li><a href=#الإصدار-الثالث>الإصدار الثالث</a></li></ul></li><li><a href=#جعلها-تتناسب-مع-rust>جعلها تتناسب مع Rust</a></li><li><a href=#تحسينات-صغيرة-إضافية>تحسينات صغيرة إضافية</a></li><li><a href=#المشاكل>المشاكل</a><ul><li><a href=#spin>Spin</a></li><li><a href=#another-type-of-deadlock>Another type of deadlock</a></li></ul></li><li><a href=#الختام-والمراجع>الختام والمراجع</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>مؤخرًا، كنت أعمل على نظام تشغيل صغير باستخدام لغة البرمجة <a href=https://www.rust-lang.org/><code>Rust</code></a> (هنا <a href=https://github.com/Amjad50/OS>OS</a>). أحد أهدافي في هذا المشروع هو بناء أكبر قدر ممكن من المكونات من الصفر (في وقت الكتابة، لا توجد تبعيات). بالطبع، ليس عليك القيام بذلك، ولكن أعتقد أن هذه فرصة جيدة للتعلم.</p><p>على أي حال، إحدى الأشياء المهمة في نظام التشغيل هي التزامن، حيث إن معظم الموارد في النظام تكون مشتركة بين عدة أنوية. لذا نحن بحاجة للتأكد من أنه يمكن لنواة واحدة فقط الوصول إلى مورد في وقت واحد، وهنا تأتي الأقفال لتلعب دورها.</p><blockquote><p>على الرغم من أنني أقول &ldquo;أنظمة التشغيل&rdquo; هنا، إلا أن هذا النوع من القفل يُستخدم في أي تطبيق بدون نظام تشغيل، مثل الأنظمة المضمنة، أو حتى في تطبيقات مساحة المستخدم.</p></blockquote><blockquote><p>أستخدم <a href=https://www.rust-lang.org/><code>Rust</code></a> هنا للتنفيذ، ولكن هذا ليس منشورًا محددًا للغة Rust، يمكنك تنفيذه في أي لغة ترغب فيها، الفكرة هي نفسها.</p></blockquote><h2 id=ما-هو-القفل>ما هو القفل؟<a hidden class=anchor aria-hidden=true href=#ما-هو-القفل>#</a></h2><p>القفل هو أساس تزامن يسمح فقط لنواة أو معالج واحد بالوصول إلى مورد في وقت واحد. عندما تحاول نواة أو معالج آخر الوصول إلى المورد، سيتم حجبه حتى تقوم النواة أو معالج الأول بإطلاق القفل، وبالتالي، يمكننا التأكد من أنه يوجد فقط نواة أو معالج واحد يمكنه الوصول إلى المورد في وقت واحد.</p><h2 id=كيف-تستخدم-الprocess-الأقفال-داخل-نظام-التشغيل>كيف تستخدم الprocess الأقفال داخل نظام التشغيل؟<a hidden class=anchor aria-hidden=true href=#كيف-تستخدم-الprocess-الأقفال-داخل-نظام-التشغيل>#</a></h2><p>في داخل نظام تشغيل عادي، تعمل الprocess بتشغيل عدة خيوط، ويدير النظام التشغيل هذه الخيوط. كما يوفر لك النظام التشغيل وسيلة لإنشاء آلية قفل بين خيوطك.</p><p>على سبيل المثال، في نظام Linux، يمكنك استخدام وظائف <a href=https://linux.die.net/man/3/pthread_mutex_lock><code>pthread_mutex_lock/unlock</code></a> لقفل/فتح كائن القفل المتزامن. القفل هنا هو أساس تزامن يسمح فقط لخيط واحد بالوصول إلى مورد في وقت واحد، وهكذا يمكنك مزامنة خيوطك.</p><p>في نظام Windows، يمكنك استخدام وظائف <a href=https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-acquiresrwlockexclusive><code>AcquireSRWLockExclusive</code></a>/<a href=https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-releasesrwlockexclusive><code>ReleaseSRWLockExclusive</code></a> لقفل/فتح كائن <a href=https://docs.microsoft.com/en-us/windows/win32/sync/slim-reader-writer--srw--locks>SRW Lock</a>.</p><p>إذاً، إنها واجهة برمجة التطبيقات التي يوفرها نظام التشغيل للسماح بتزامن فعّال بين الخيوط. عندما يكون الخيط في انتظار القفل، يدخل في حالة انتظار، وبالتالي لا يستهلك الكثير من وحدات المعالجة المركزية.</p><h2 id=كيف-يمكننا-صناعة-أقفال-خاصة-بنا-في-نظام-التشغيل>كيف يمكننا صناعة أقفال خاصة بنا في نظام التشغيل؟<a hidden class=anchor aria-hidden=true href=#كيف-يمكننا-صناعة-أقفال-خاصة-بنا-في-نظام-التشغيل>#</a></h2><p>داخل النواة، ليس لدينا نظام تشغيل رئيسي يقدم لنا آلية إقفال، لذا يجب أن نقوم بتنفيذها بأنفسنا بطريقة ما.</p><p>وهنا يأتي <strong>القفل الدوراني</strong>، القفل الدوراني هو قفل ينتظر بشكل نشط حتى يتاح الوصول إليه. لذا، إذا كان هناك نواتين، وإحدى النواتين تحمل القفل، ستبقى النواة الأخرى في حلقة تنتظر حتى يتاح فتح القفل، ثم تقوم بالحصول عليه.</p><h2 id=عمل-قفل-دوراني>عمل قفل دوراني<a hidden class=anchor aria-hidden=true href=#عمل-قفل-دوراني>#</a></h2><p>حسنًا، لدينا الفكرة الأولى في عقولنا الآن، دعونا نقوم بتنفيذها.</p><p>لنفترض أن لدينا دالة بإسم <code>handle_resource</code> تقوم بتنفيذ بعض الإجراءات على مورد مشترك، ونريد التأكد من أنه يمكن لنواة واحدة فقط الوصول إلى المورد في وقت واحد، لذا سنستخدم دالة القفل الدوراني لذلك.</p><p>سيكون المورد في متغير ثابت <code>static</code>، نظرًا لأننا نريد الوصول إليه من أي مكان. سنقوم بتنفيذ القفل في عدة تحديثات ونشرح المشكلة مع كل واحدة.</p><h3 id=الإصدار-الأول>الإصدار الأول<a hidden class=anchor aria-hidden=true href=#الإصدار-الأول>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15>15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16>16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17>17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18>18</a>
</span><span class=lnt id=hl-0-19><a class=lnlinks href=#hl-0-19>19</a>
</span><span class=lnt id=hl-0-20><a class=lnlinks href=#hl-0-20>20</a>
</span><span class=lnt id=hl-0-21><a class=lnlinks href=#hl-0-21>21</a>
</span><span class=lnt id=hl-0-22><a class=lnlinks href=#hl-0-22>22</a>
</span><span class=lnt id=hl-0-23><a class=lnlinks href=#hl-0-23>23</a>
</span><span class=lnt id=hl-0-24><a class=lnlinks href=#hl-0-24>24</a>
</span><span class=lnt id=hl-0-25><a class=lnlinks href=#hl-0-25>25</a>
</span><span class=lnt id=hl-0-26><a class=lnlinks href=#hl-0-26>26</a>
</span><span class=lnt id=hl-0-27><a class=lnlinks href=#hl-0-27>27</a>
</span><span class=lnt id=hl-0-28><a class=lnlinks href=#hl-0-28>28</a>
</span><span class=lnt id=hl-0-29><a class=lnlinks href=#hl-0-29>29</a>
</span><span class=lnt id=hl-0-30><a class=lnlinks href=#hl-0-30>30</a>
</span><span class=lnt id=hl-0-31><a class=lnlinks href=#hl-0-31>31</a>
</span><span class=lnt id=hl-0-32><a class=lnlinks href=#hl-0-32>32</a>
</span><span class=lnt id=hl-0-33><a class=lnlinks href=#hl-0-33>33</a>
</span><span class=lnt id=hl-0-34><a class=lnlinks href=#hl-0-34>34</a>
</span><span class=lnt id=hl-0-35><a class=lnlinks href=#hl-0-35>35</a>
</span><span class=lnt id=hl-0-36><a class=lnlinks href=#hl-0-36>36</a>
</span><span class=lnt id=hl-0-37><a class=lnlinks href=#hl-0-37>37</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Spinlock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>locked</span>: <span class=kt>bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Spinlock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>new</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>Self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>Self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>locked</span>: <span class=nc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>lock</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>locked</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// spin
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>locked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>locked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>static</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=no>GLOBAL_LOCK</span>: <span class=nc>Spinlock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Spinlock</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>static</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=no>GLOBAL_RESOURCE</span>: <span class=kt>u32</span> <span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// this will be called from multiple cores
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>fn</span> <span class=nf>kernel_main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// SAFETY: is this safe?
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=no>GLOBAL_LOCK</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// SAFETY: we know that we are the only core accessing this resource
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=c1>//         so its safe to access it
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=no>GLOBAL_RESOURCE</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=no>GLOBAL_LOCK</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>هنا، قمنا بتنفيذ قفل دوراني باستخدام متغير <code>bool</code>. لدينا دالة <code>lock</code> التي تنتظر بشكل نشط حتى يتاح الوصول إلى القفل، ثم نقوم بتعيين متغير <code>locked</code> إلى <code>true</code>. ولدينا أيضًا دالة <code>unlock</code> التي تقوم بتعيين متغير <code>locked</code> إلى <code>false</code>.</p><p>لكن هناك مشكلة كبيرة، هناك فجوة بين حلقة <code>while</code> وتعيين متغير <code>locked</code> إلى <code>true</code>، وفي هذه الفجوة، يمكن لنواة أخرى أن تأخذ القفل ولكننا لن نعلم عنها، وبالتالي، سيكون لدينا نواتين تصل إلى المورد في نفس الوقت.</p><p>عرض المشكلة في رسم توضيحي:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=n>Core1</span>: <span class=nc>lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>-</span><span class=w> </span><span class=n>Core1</span>: <span class=nc>self</span><span class=p>.</span><span class=n>locked</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>false</span><span class=w>    </span><span class=c1>// `غير مقفل، قم بتعيينه إلى `صحيح
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Core2</span>: <span class=nc>lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>-</span><span class=w> </span><span class=n>Core2</span>: <span class=nc>self</span><span class=p>.</span><span class=n>locked</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>false</span><span class=w>    </span><span class=c1>// `غير مقفل، قم بتعيينه إلى `صحيح
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>-</span><span class=w> </span><span class=n>Core1</span>: <span class=nc>self</span><span class=p>.</span><span class=n>locked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>-</span><span class=w> </span><span class=n>Core2</span>: <span class=nc>self</span><span class=p>.</span><span class=n>locked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// الآن لديهم النواتين القفل
</span></span></span></code></pre></div><p>لنحاول حل هذه المشكلة.</p><h3 id=الإصدار-الثاني>الإصدار الثاني<a hidden class=anchor aria-hidden=true href=#الإصدار-الثاني>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1> 1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2> 2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3> 3</a>
</span><span class=hl><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4> 4</a>
</span></span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5> 5</a>
</span><span class=lnt id=hl-2-6><a class=lnlinks href=#hl-2-6> 6</a>
</span><span class=lnt id=hl-2-7><a class=lnlinks href=#hl-2-7> 7</a>
</span><span class=lnt id=hl-2-8><a class=lnlinks href=#hl-2-8> 8</a>
</span><span class=lnt id=hl-2-9><a class=lnlinks href=#hl-2-9> 9</a>
</span><span class=hl><span class=lnt id=hl-2-10><a class=lnlinks href=#hl-2-10>10</a>
</span></span><span class=lnt id=hl-2-11><a class=lnlinks href=#hl-2-11>11</a>
</span><span class=lnt id=hl-2-12><a class=lnlinks href=#hl-2-12>12</a>
</span><span class=lnt id=hl-2-13><a class=lnlinks href=#hl-2-13>13</a>
</span><span class=lnt id=hl-2-14><a class=lnlinks href=#hl-2-14>14</a>
</span><span class=hl><span class=lnt id=hl-2-15><a class=lnlinks href=#hl-2-15>15</a>
</span></span><span class=hl><span class=lnt id=hl-2-16><a class=lnlinks href=#hl-2-16>16</a>
</span></span><span class=hl><span class=lnt id=hl-2-17><a class=lnlinks href=#hl-2-17>17</a>
</span></span><span class=lnt id=hl-2-18><a class=lnlinks href=#hl-2-18>18</a>
</span><span class=lnt id=hl-2-19><a class=lnlinks href=#hl-2-19>19</a>
</span><span class=lnt id=hl-2-20><a class=lnlinks href=#hl-2-20>20</a>
</span><span class=hl><span class=lnt id=hl-2-21><a class=lnlinks href=#hl-2-21>21</a>
</span></span><span class=lnt id=hl-2-22><a class=lnlinks href=#hl-2-22>22</a>
</span><span class=lnt id=hl-2-23><a class=lnlinks href=#hl-2-23>23</a>
</span><span class=lnt id=hl-2-24><a class=lnlinks href=#hl-2-24>24</a>
</span><span class=hl><span class=lnt id=hl-2-25><a class=lnlinks href=#hl-2-25>25</a>
</span></span><span class=lnt id=hl-2-26><a class=lnlinks href=#hl-2-26>26</a>
</span><span class=lnt id=hl-2-27><a class=lnlinks href=#hl-2-27>27</a>
</span><span class=lnt id=hl-2-28><a class=lnlinks href=#hl-2-28>28</a>
</span><span class=lnt id=hl-2-29><a class=lnlinks href=#hl-2-29>29</a>
</span><span class=hl><span class=lnt id=hl-2-30><a class=lnlinks href=#hl-2-30>30</a>
</span></span><span class=lnt id=hl-2-31><a class=lnlinks href=#hl-2-31>31</a>
</span><span class=lnt id=hl-2-32><a class=lnlinks href=#hl-2-32>32</a>
</span><span class=lnt id=hl-2-33><a class=lnlinks href=#hl-2-33>33</a>
</span><span class=lnt id=hl-2-34><a class=lnlinks href=#hl-2-34>34</a>
</span><span class=lnt id=hl-2-35><a class=lnlinks href=#hl-2-35>35</a>
</span><span class=lnt id=hl-2-36><a class=lnlinks href=#hl-2-36>36</a>
</span><span class=hl><span class=lnt id=hl-2-37><a class=lnlinks href=#hl-2-37>37</a>
</span></span><span class=lnt id=hl-2-38><a class=lnlinks href=#hl-2-38>38</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>core</span>::<span class=n>sync</span>::<span class=n>atomic</span>::<span class=p>{</span><span class=n>AtomicBool</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>Spinlock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=n>locked</span>: <span class=nc>AtomicBool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Spinlock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>new</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>Self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>Self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>            </span><span class=n>locked</span>: <span class=nc>AtomicBool</span>::<span class=n>new</span><span class=p>(</span><span class=kc>false</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>lock</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>locked</span><span class=p>.</span><span class=n>compare_exchange</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Acquire</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Relaxed</span><span class=p>).</span><span class=n>is_err</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>            </span><span class=c1>// spin
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>locked</span><span class=p>.</span><span class=n>store</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Release</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w></span><span class=k>static</span><span class=w> </span><span class=no>GLOBAL_LOCK</span>: <span class=nc>Spinlock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Spinlock</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>static</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=no>GLOBAL_RESOURCE</span>: <span class=kt>u32</span> <span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// this will be called from multiple cores
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>fn</span> <span class=nf>kernel_main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=no>GLOBAL_LOCK</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// SAFETY: we know that we are the only core accessing this resource
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=c1>//         so its safe to access it
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=no>GLOBAL_RESOURCE</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=no>GLOBAL_LOCK</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>إذا، هنا نستخدم <a href=https://doc.rust-lang.org/std/sync/atomic/struct.AtomicBool.html><code>AtomicBool</code></a> بدلاً من <code>bool</code> العادي، ونستخدم <a href=https://doc.rust-lang.org/std/sync/atomic/struct.AtomicBool.html#method.compare_exchange><code>compare_exchange</code></a> لتعيين المتغير <code>locked</code> إلى <code>true</code> بطريقة ما؟ أيضًا إذا لاحظت، فإن القفل الآن ليس <code>mut</code>، ونحن نستخدم <code>self&</code> بدلاً من <code>mut self&</code>، وبالتالي يُسمح لنا باستخدامه من <code>static</code> بدون أي <code>unsafe</code>.</p><p>ولكن كيف يعمل ذلك؟</p><p><a href=https://doc.rust-lang.org/std/sync/atomic/struct.AtomicBool.html><code>AtomicBool</code></a> هو قيمة منطقية يمكن الوصول إليها بشكل ذري، وهذا يعني أن كل عملية تتم على هذا النوع تتم ذريًا، أي أن العملية كلها تتم كوحدة واحدة، وبالتالي، لا يمكن لنواة أخرى الوصول إلى المتغير في منتصف العملية.</p><p>دالة <a href=https://doc.rust-lang.org/std/sync/atomic/struct.AtomicBool.html#method.compare_exchange><code>compare_exchange</code></a> هي عملية ذرية تقارن قيمة المتغير بالقيمة الأولى، وإذا كانت متساوية، يتم تعيين قيمة المتغير إلى القيمة الثانية ذريًا، لا يمكن لنواتان أن تعينان القيمة في نفس الوقت، ستفوز نواة واحدة فقط في السباق. ثم تعيد الدالة <code>Ok</code> إذا كانت العملية ناجحة، و <code>Err</code> في غير ذلك (يرجى الرجوع إلى الdocs للمزيد من المعلومات).</p><p>بسبب كيفية عمل العمليات الذرية، يمكن لراست جعل الدوال تستخدم <code>&amp;self</code> بدلاً من <code>&amp;mut self</code>، لأنها يمكنها ضمان أن لا نواة أخرى يمكنها الوصول إلى المتغير في نفس الوقت. وبالتالي يمكننا تقليل الكود غير الآمن.</p><p>شيء آخر يجب ملاحظته هو <a href=https://doc.rust-lang.org/std/sync/atomic/enum.Ordering.html><code>Ordering</code></a>، يُحدد للمعالج كيف يمكنه ترتيب العمليات في الذاكرة المتعلقة بالعملية التزامنية، وكيف يؤثر على عمليات الذاكرة الأخرى حول العملية الذرية.</p><p>لشرح بسيط جدًا، <code>Ordering::Acquire</code> سيضمن أن جميع عمليات الذاكرة قبل العملية الذرية ستظهر للنواة الأخرى، و <code>Ordering::Release</code> سيضمن أن جميع عمليات الذاكرة بعد العملية الذرية ستظهر للنواة الأخرى.</p><p><code>Ordering::Relaxed</code> هو الترتيب الأضعف، ولا يضمن أي شيء على العمليات الأخرى، ولكنه فقط يضمن أن الذاكرة الملامسة بواسطة العملية الذرية ستظهر للنواة الأخرى (للمزيد من المعلومات حول هذا انظر إلى الdocs أو <a href=https://marabos.nl/atomics/>Book: Rust Atomics and Locks</a>).</p><p>إذاً، عظيم، حلنا المشكلة، صحيح؟ حسنًا، نعم، ولكن هناك مشكلة أخرى.</p><p>هذه المشكلة مختصة فقط بتنفيذ نواة، وهي &ldquo;المقاطعات&rdquo;.</p><p>عندما تكون داخل النواة، لا تخاف من النواة الأخرى فقط، ولكنك أيضًا تخاف من نفسك. يمكن أن تجد نفسك وراء ظهرك دون أن تلاحظ D:</p><p>هنا كيف يمكن أن يحدث ذلك.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>self</span><span class=p>.</span><span class=n>locked</span><span class=p>.</span><span class=n>compare_exchange</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Acquire</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Relaxed</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>Ok</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...القفل مغلق الآن، ونحن نقوم بعمل ما هنا، ولم ننتهِ بعد
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=p>[</span><span class=n>interrupt</span><span class=p>]</span><span class=w> </span><span class=c1>// المقاطعة
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>lock</span><span class=p>()</span><span class=w>  </span><span class=c1>// نفس القفل مرة أخرى.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>while</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>locked</span><span class=p>.</span><span class=n>compare_exchange</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Acquire</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Relaxed</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>Err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ....معلق للأبد
</span></span></span></code></pre></div><p>وهذا، أيها الأصدقاء، يُعرف باسم <strong>الانغلاق</strong>.</p><p>الانغلاق هو حالة يكون فيها خيط أو النواة في انتظار قفل يمتلكه بالفعل، وبالتالي، لن يكون قادرًا أبدًا على الحصول على القفل.</p><p>إذا، كيف يمكننا حل هذه المشكلة؟</p><h3 id=الإصدار-الثالث>الإصدار الثالث<a hidden class=anchor aria-hidden=true href=#الإصدار-الثالث>#</a></h3><p>طريقة واحدة لحل هذه المشكلة هي من خلال منع وحدة المعالجة المركزية من استقبال المقاطعات أثناء الاحتفاظ بالقفل، بحيث لا يتم تشويشنا والوقوع في هذا الوضع.</p><p>هنا، أقوم فقط بتنفيذها لوحدة المعالجة المركزية <code>x86-64</code>، لذا هذا الجزء يعتمد على نوع الوحدة المعالجة المركزية، ولكن الفكرة هي نفسها للوحدات المعالجة المركزية الأخرى باستخدام تعليمات مختلفة.</p><blockquote><p>لن أكرر الكود القديم الذي لا يتغير</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1> 1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2> 2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3> 3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4> 4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5> 5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6> 6</a>
</span><span class=hl><span class=lnt id=hl-4-7><a class=lnlinks href=#hl-4-7> 7</a>
</span></span><span class=hl><span class=lnt id=hl-4-8><a class=lnlinks href=#hl-4-8> 8</a>
</span></span><span class=hl><span class=lnt id=hl-4-9><a class=lnlinks href=#hl-4-9> 9</a>
</span></span><span class=hl><span class=lnt id=hl-4-10><a class=lnlinks href=#hl-4-10>10</a>
</span></span><span class=hl><span class=lnt id=hl-4-11><a class=lnlinks href=#hl-4-11>11</a>
</span></span><span class=hl><span class=lnt id=hl-4-12><a class=lnlinks href=#hl-4-12>12</a>
</span></span><span class=hl><span class=lnt id=hl-4-13><a class=lnlinks href=#hl-4-13>13</a>
</span></span><span class=lnt id=hl-4-14><a class=lnlinks href=#hl-4-14>14</a>
</span><span class=hl><span class=lnt id=hl-4-15><a class=lnlinks href=#hl-4-15>15</a>
</span></span><span class=hl><span class=lnt id=hl-4-16><a class=lnlinks href=#hl-4-16>16</a>
</span></span><span class=hl><span class=lnt id=hl-4-17><a class=lnlinks href=#hl-4-17>17</a>
</span></span><span class=hl><span class=lnt id=hl-4-18><a class=lnlinks href=#hl-4-18>18</a>
</span></span><span class=hl><span class=lnt id=hl-4-19><a class=lnlinks href=#hl-4-19>19</a>
</span></span><span class=hl><span class=lnt id=hl-4-20><a class=lnlinks href=#hl-4-20>20</a>
</span></span><span class=hl><span class=lnt id=hl-4-21><a class=lnlinks href=#hl-4-21>21</a>
</span></span><span class=hl><span class=lnt id=hl-4-22><a class=lnlinks href=#hl-4-22>22</a>
</span></span><span class=lnt id=hl-4-23><a class=lnlinks href=#hl-4-23>23</a>
</span><span class=lnt id=hl-4-24><a class=lnlinks href=#hl-4-24>24</a>
</span><span class=lnt id=hl-4-25><a class=lnlinks href=#hl-4-25>25</a>
</span><span class=hl><span class=lnt id=hl-4-26><a class=lnlinks href=#hl-4-26>26</a>
</span></span><span class=lnt id=hl-4-27><a class=lnlinks href=#hl-4-27>27</a>
</span><span class=lnt id=hl-4-28><a class=lnlinks href=#hl-4-28>28</a>
</span><span class=lnt id=hl-4-29><a class=lnlinks href=#hl-4-29>29</a>
</span><span class=lnt id=hl-4-30><a class=lnlinks href=#hl-4-30>30</a>
</span><span class=lnt id=hl-4-31><a class=lnlinks href=#hl-4-31>31</a>
</span><span class=lnt id=hl-4-32><a class=lnlinks href=#hl-4-32>32</a>
</span><span class=lnt id=hl-4-33><a class=lnlinks href=#hl-4-33>33</a>
</span><span class=lnt id=hl-4-34><a class=lnlinks href=#hl-4-34>34</a>
</span><span class=hl><span class=lnt id=hl-4-35><a class=lnlinks href=#hl-4-35>35</a>
</span></span><span class=lnt id=hl-4-36><a class=lnlinks href=#hl-4-36>36</a>
</span><span class=lnt id=hl-4-37><a class=lnlinks href=#hl-4-37>37</a>
</span><span class=lnt id=hl-4-38><a class=lnlinks href=#hl-4-38>38</a>
</span><span class=lnt id=hl-4-39><a class=lnlinks href=#hl-4-39>39</a>
</span><span class=lnt id=hl-4-40><a class=lnlinks href=#hl-4-40>40</a>
</span><span class=lnt id=hl-4-41><a class=lnlinks href=#hl-4-41>41</a>
</span><span class=hl><span class=lnt id=hl-4-42><a class=lnlinks href=#hl-4-42>42</a>
</span></span><span class=lnt id=hl-4-43><a class=lnlinks href=#hl-4-43>43</a>
</span><span class=lnt id=hl-4-44><a class=lnlinks href=#hl-4-44>44</a>
</span><span class=lnt id=hl-4-45><a class=lnlinks href=#hl-4-45>45</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Cpu</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>old_interrupt_state</span>: <span class=kt>bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>number_pushed</span>: <span class=kt>u32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Cpu</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>push_interrupt_disable</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>number_pushed</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>old_interrupt_state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cpu_specific</span>::<span class=n>current_interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>            </span><span class=n>cpu_specific</span>::<span class=n>disable_interrupts</span><span class=p>();</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>number_pushed</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>pop_interrupt_disable</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>number_pushed</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>number_pushed</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>old_interrupt_state</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>                </span><span class=n>x86_64</span>::<span class=n>instructions</span>::<span class=n>interrupts</span>::<span class=n>enable</span><span class=p>();</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>current_cpu</span><span class=p>()</span><span class=w> </span>-&gt; <span class=kp>&amp;</span><span class=nb>&#39;static</span> <span class=nc>mut</span><span class=w> </span><span class=n>Cpu</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// get a static variable or something
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// we can use an array hosting all the CPUs structs for example, 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// and ensuring an index is only usable by one core
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Spinlock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>lock</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>        </span><span class=n>current_cpu</span><span class=p>().</span><span class=n>push_interrupt_disable</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>locked</span><span class=p>.</span><span class=n>compare_exchange</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Acquire</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Relaxed</span><span class=p>).</span><span class=n>is_err</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// spin
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>locked</span><span class=p>.</span><span class=n>store</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Release</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>current_cpu</span><span class=p>().</span><span class=n>pop_interrupt_disable</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>حسنًا، هذا الكثير من الكود. دعونا نقم بشرحها.</p><p>لذا، كان لدينا خطة لتعطيل المقاطعات. ولكن كيف يمكننا القيام بذلك بشكل آمن.</p><p>إذا قمنا بتنفيذ <code>()cpu::disable_interrupts</code> بطريقة ساذجة، على سبيل المثال داخل القفل، ثم <code>()cpu::enable_interrupts</code> داخل الإلغاء، سنواجه مشكلة، حيث ستفشل إذا كانت هناك أقفال متداخلة.</p><p>لنرى.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>Lock1</span>::<span class=n>lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>cpu</span>::<span class=n>disable_interrupts</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>self</span><span class=p>.</span><span class=n>locked</span><span class=p>.</span><span class=n>compare_exchange</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Acquire</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Relaxed</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>Ok</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// القفل مغلق الآن، ولن نتلقى المقاطعات
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>Lock2</span>::<span class=n>lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>cpu</span>::<span class=n>disable_interrupts</span><span class=p>()</span><span class=w>   </span><span class=c1>// منعت بالفعل، ولكن مهما كان الأمر
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>self</span><span class=p>.</span><span class=n>locked</span><span class=p>.</span><span class=n>compare_exchange</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Acquire</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Relaxed</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>Ok</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// القفل مغلق الآن، ولن نتلقى المقاطعات
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>Lock2</span>::<span class=n>unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>self</span><span class=p>.</span><span class=n>locked</span><span class=p>.</span><span class=n>store</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Release</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>cpu</span>::<span class=n>enable_interrupts</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// المقاطعات مُمكّنة الآن
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=p>[</span><span class=n>interrupt</span><span class=p>]</span><span class=c1>// المقاطعة
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>Lock1</span>::<span class=n>lock</span><span class=p>()</span><span class=w>  </span><span class=c1>// نفس القفل مرة أخرى، وواجهنا نفس المشكلة، حيث قمنا بتمكين المقاطعات في مكان لا ينبغي
</span></span></span></code></pre></div><p>إذاً، علينا حل هذه المشكلة، يمكن حلها بسهولة عن طريق تذكر كم مرة قمنا بتعطيل المقاطعات،
ثم العودة للخلف، وتمكين المقاطعات بعد التأكد من عدم توقع أحد تعطيل المقاطعات.</p><p>المثال أعلاه سيكون كالتالي مع تنفيذ <a href=#hl-4-7><code>push_interrupt_disable</code></a> و <a href=#hl-4-15><code>pop_interrupt_disable</code></a>:</p><blockquote><p>لا نحتاج إلى استخدام <strong>atomic</strong> عند زيادة <code>number_pushed</code>، لأن خط الإضافة سيُنفذ مرة واحدة فقط
عند تعطيل المقاطعات، ويجب أن يكون هذا الهيكل يستخدم فقط من قبل نواة مالكة واحدة، أي أن النوى الأخرى لن تنفذ
هذا الشيفرة على الإطلاق (لم يتم تنفيذ هذا هنا، أتركها كتمرين للقارئ).</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>Lock1</span>::<span class=n>lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>push_interrupt_disable</span><span class=p>()</span><span class=w>    </span><span class=c1>// interrupt=false, number_pushed=1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>self</span><span class=p>.</span><span class=n>locked</span><span class=p>.</span><span class=n>compare_exchange</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Acquire</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Relaxed</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>Ok</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// القفل مغلق الآن، ولن نتلقى المقاطعات
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>Lock2</span>::<span class=n>lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>push_interrupt_disable</span><span class=p>()</span><span class=w>   </span><span class=c1>// interrupt=false, number_pushed=2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>self</span><span class=p>.</span><span class=n>locked</span><span class=p>.</span><span class=n>compare_exchange</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Acquire</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Relaxed</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>Ok</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// القفل مغلق الآن، ولن نتلقى المقاطعات
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>Lock2</span>::<span class=n>unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>self</span><span class=p>.</span><span class=n>locked</span><span class=p>.</span><span class=n>store</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Release</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>pop_interrupt_disable</span><span class=p>()</span><span class=w> </span><span class=c1>// interrupt=false, number_pushed=1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=c1>// المقاطعات ما زالت معطلة
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>Lock1</span>::<span class=n>unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>self</span><span class=p>.</span><span class=n>locked</span><span class=p>.</span><span class=n>store</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Release</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Core</span><span class=w> </span><span class=mi>1</span>: <span class=nc>pop_interrupt_disable</span><span class=p>()</span><span class=w> </span><span class=c1>// interrupt=true, number_pushed=0
</span></span></span><span class=line><span class=cl><span class=c1>// المقاطعات مُمكّنة الآن وكل شيء آمن
</span></span></span></code></pre></div><p>ونعم، هذا هو كل شيء، لدينا الآن قفل دوراني يعمل.
أعتقد أن هذا آمن من جميع المشاكل التي وجدتها، ولكن إذا وجدت أي مشكلة، فالرجاء إعلامي :)</p><h2 id=جعلها-تتناسب-مع-rust>جعلها تتناسب مع Rust<a hidden class=anchor aria-hidden=true href=#جعلها-تتناسب-مع-rust>#</a></h2><p>لدينا قفل الآن، ولكن استخدامه يبدو غير جميل، انظر إلى هذا:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1>1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2>2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3>3</a>
</span><span class=lnt id=hl-7-4><a class=lnlinks href=#hl-7-4>4</a>
</span><span class=lnt id=hl-7-5><a class=lnlinks href=#hl-7-5>5</a>
</span><span class=lnt id=hl-7-6><a class=lnlinks href=#hl-7-6>6</a>
</span><span class=lnt id=hl-7-7><a class=lnlinks href=#hl-7-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=no>GLOBAL_LOCK</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// SAFETY: we know that we are the only core accessing this resource so its safe to access it
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=no>GLOBAL_RESOURCE</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=no>GLOBAL_LOCK</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>يمكننا تحسين الوضع عن طريق إنشاء نوع يحتوي على البيانات والقفل، ويدير جميع الأمور <code>unsafe</code> بالنيابة عنا حتى لا نضطر إلى القيام بذلك.</p><p>يمكننا الحصول على إلهام من نوع <a href=https://doc.rust-lang.org/std/sync/struct.Mutex.html><code>Mutex</code></a> في المكتبة القياسية.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1> 1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2> 2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3> 3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4> 4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5> 5</a>
</span><span class=lnt id=hl-8-6><a class=lnlinks href=#hl-8-6> 6</a>
</span><span class=lnt id=hl-8-7><a class=lnlinks href=#hl-8-7> 7</a>
</span><span class=lnt id=hl-8-8><a class=lnlinks href=#hl-8-8> 8</a>
</span><span class=lnt id=hl-8-9><a class=lnlinks href=#hl-8-9> 9</a>
</span><span class=lnt id=hl-8-10><a class=lnlinks href=#hl-8-10>10</a>
</span><span class=lnt id=hl-8-11><a class=lnlinks href=#hl-8-11>11</a>
</span><span class=lnt id=hl-8-12><a class=lnlinks href=#hl-8-12>12</a>
</span><span class=lnt id=hl-8-13><a class=lnlinks href=#hl-8-13>13</a>
</span><span class=lnt id=hl-8-14><a class=lnlinks href=#hl-8-14>14</a>
</span><span class=lnt id=hl-8-15><a class=lnlinks href=#hl-8-15>15</a>
</span><span class=lnt id=hl-8-16><a class=lnlinks href=#hl-8-16>16</a>
</span><span class=lnt id=hl-8-17><a class=lnlinks href=#hl-8-17>17</a>
</span><span class=lnt id=hl-8-18><a class=lnlinks href=#hl-8-18>18</a>
</span><span class=lnt id=hl-8-19><a class=lnlinks href=#hl-8-19>19</a>
</span><span class=lnt id=hl-8-20><a class=lnlinks href=#hl-8-20>20</a>
</span><span class=lnt id=hl-8-21><a class=lnlinks href=#hl-8-21>21</a>
</span><span class=lnt id=hl-8-22><a class=lnlinks href=#hl-8-22>22</a>
</span><span class=lnt id=hl-8-23><a class=lnlinks href=#hl-8-23>23</a>
</span><span class=lnt id=hl-8-24><a class=lnlinks href=#hl-8-24>24</a>
</span><span class=lnt id=hl-8-25><a class=lnlinks href=#hl-8-25>25</a>
</span><span class=lnt id=hl-8-26><a class=lnlinks href=#hl-8-26>26</a>
</span><span class=lnt id=hl-8-27><a class=lnlinks href=#hl-8-27>27</a>
</span><span class=lnt id=hl-8-28><a class=lnlinks href=#hl-8-28>28</a>
</span><span class=lnt id=hl-8-29><a class=lnlinks href=#hl-8-29>29</a>
</span><span class=lnt id=hl-8-30><a class=lnlinks href=#hl-8-30>30</a>
</span><span class=lnt id=hl-8-31><a class=lnlinks href=#hl-8-31>31</a>
</span><span class=lnt id=hl-8-32><a class=lnlinks href=#hl-8-32>32</a>
</span><span class=lnt id=hl-8-33><a class=lnlinks href=#hl-8-33>33</a>
</span><span class=lnt id=hl-8-34><a class=lnlinks href=#hl-8-34>34</a>
</span><span class=lnt id=hl-8-35><a class=lnlinks href=#hl-8-35>35</a>
</span><span class=lnt id=hl-8-36><a class=lnlinks href=#hl-8-36>36</a>
</span><span class=lnt id=hl-8-37><a class=lnlinks href=#hl-8-37>37</a>
</span><span class=lnt id=hl-8-38><a class=lnlinks href=#hl-8-38>38</a>
</span><span class=lnt id=hl-8-39><a class=lnlinks href=#hl-8-39>39</a>
</span><span class=lnt id=hl-8-40><a class=lnlinks href=#hl-8-40>40</a>
</span><span class=lnt id=hl-8-41><a class=lnlinks href=#hl-8-41>41</a>
</span><span class=lnt id=hl-8-42><a class=lnlinks href=#hl-8-42>42</a>
</span><span class=lnt id=hl-8-43><a class=lnlinks href=#hl-8-43>43</a>
</span><span class=lnt id=hl-8-44><a class=lnlinks href=#hl-8-44>44</a>
</span><span class=lnt id=hl-8-45><a class=lnlinks href=#hl-8-45>45</a>
</span><span class=lnt id=hl-8-46><a class=lnlinks href=#hl-8-46>46</a>
</span><span class=lnt id=hl-8-47><a class=lnlinks href=#hl-8-47>47</a>
</span><span class=lnt id=hl-8-48><a class=lnlinks href=#hl-8-48>48</a>
</span><span class=lnt id=hl-8-49><a class=lnlinks href=#hl-8-49>49</a>
</span><span class=lnt id=hl-8-50><a class=lnlinks href=#hl-8-50>50</a>
</span><span class=lnt id=hl-8-51><a class=lnlinks href=#hl-8-51>51</a>
</span><span class=lnt id=hl-8-52><a class=lnlinks href=#hl-8-52>52</a>
</span><span class=lnt id=hl-8-53><a class=lnlinks href=#hl-8-53>53</a>
</span><span class=lnt id=hl-8-54><a class=lnlinks href=#hl-8-54>54</a>
</span><span class=lnt id=hl-8-55><a class=lnlinks href=#hl-8-55>55</a>
</span><span class=lnt id=hl-8-56><a class=lnlinks href=#hl-8-56>56</a>
</span><span class=lnt id=hl-8-57><a class=lnlinks href=#hl-8-57>57</a>
</span><span class=lnt id=hl-8-58><a class=lnlinks href=#hl-8-58>58</a>
</span><span class=lnt id=hl-8-59><a class=lnlinks href=#hl-8-59>59</a>
</span><span class=lnt id=hl-8-60><a class=lnlinks href=#hl-8-60>60</a>
</span><span class=lnt id=hl-8-61><a class=lnlinks href=#hl-8-61>61</a>
</span><span class=lnt id=hl-8-62><a class=lnlinks href=#hl-8-62>62</a>
</span><span class=lnt id=hl-8-63><a class=lnlinks href=#hl-8-63>63</a>
</span><span class=lnt id=hl-8-64><a class=lnlinks href=#hl-8-64>64</a>
</span><span class=lnt id=hl-8-65><a class=lnlinks href=#hl-8-65>65</a>
</span><span class=lnt id=hl-8-66><a class=lnlinks href=#hl-8-66>66</a>
</span><span class=lnt id=hl-8-67><a class=lnlinks href=#hl-8-67>67</a>
</span><span class=lnt id=hl-8-68><a class=lnlinks href=#hl-8-68>68</a>
</span><span class=lnt id=hl-8-69><a class=lnlinks href=#hl-8-69>69</a>
</span><span class=lnt id=hl-8-70><a class=lnlinks href=#hl-8-70>70</a>
</span><span class=lnt id=hl-8-71><a class=lnlinks href=#hl-8-71>71</a>
</span><span class=lnt id=hl-8-72><a class=lnlinks href=#hl-8-72>72</a>
</span><span class=lnt id=hl-8-73><a class=lnlinks href=#hl-8-73>73</a>
</span><span class=lnt id=hl-8-74><a class=lnlinks href=#hl-8-74>74</a>
</span><span class=lnt id=hl-8-75><a class=lnlinks href=#hl-8-75>75</a>
</span><span class=lnt id=hl-8-76><a class=lnlinks href=#hl-8-76>76</a>
</span><span class=lnt id=hl-8-77><a class=lnlinks href=#hl-8-77>77</a>
</span><span class=lnt id=hl-8-78><a class=lnlinks href=#hl-8-78>78</a>
</span><span class=lnt id=hl-8-79><a class=lnlinks href=#hl-8-79>79</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>core</span>::<span class=p>{</span><span class=n>cell</span>::<span class=n>UnsafeCell</span><span class=p>,</span><span class=w> </span><span class=n>ops</span>::<span class=p>{</span><span class=n>Deref</span><span class=p>,</span><span class=w> </span><span class=n>DerefMut</span><span class=p>}};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// you can put this in `spin::Mutex` or something
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=nc>SpinMutex</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span>: <span class=nc>Spinlock</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>data</span>: <span class=nc>UnsafeCell</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// impl extra stuff here, like `unsafe Send/Sync`, `Debug`, I won&#39;t go into details here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>SpinMutex</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>new</span><span class=p>(</span><span class=n>data</span>: <span class=nc>T</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>Self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span>: <span class=nc>Spinlock</span>::<span class=n>new</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>data</span>: <span class=nc>UnsafeCell</span>::<span class=n>new</span><span class=p>(</span><span class=n>data</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>lock</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>SpinMutexGuard</span><span class=o>&lt;</span><span class=nb>&#39;_</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>lock</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SpinMutexGuard</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span>: <span class=kp>&amp;</span><span class=nc>self</span><span class=p>.</span><span class=n>lock</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// SAFETY: we know that we are the only core accessing this resource so its safe to access it
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>data</span>: <span class=nc>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=o>*</span><span class=bp>self</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>get</span><span class=p>()</span><span class=w> </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// extra function here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>fn</span> <span class=nf>try_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Option</span><span class=o>&lt;</span><span class=n>SpinMutexGuard</span><span class=o>&lt;</span><span class=nb>&#39;_</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// `try_lock` here just performs `lock` but without looping
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=c1>// it will return `true` if the lock was acquired, and `false` otherwise
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>lock</span><span class=p>.</span><span class=n>try_lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Some</span><span class=p>(</span><span class=n>SpinMutexGuard</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>lock</span>: <span class=kp>&amp;</span><span class=nc>self</span><span class=p>.</span><span class=n>lock</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>data</span>: <span class=nc>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=o>*</span><span class=bp>self</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>get</span><span class=p>()</span><span class=w> </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>lock</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>SpinMutexGuard</span><span class=o>&lt;</span><span class=na>&#39;a</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span>: <span class=kp>&amp;</span><span class=na>&#39;a</span> <span class=nc>Spinlock</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>data</span>: <span class=kp>&amp;</span><span class=na>&#39;a</span> <span class=nc>mut</span><span class=w> </span><span class=n>T</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=o>&lt;</span><span class=na>&#39;a</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>Deref</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>SpinMutexGuard</span><span class=o>&lt;</span><span class=na>&#39;a</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>type</span> <span class=nc>Target</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>T</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>deref</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kp>&amp;</span><span class=nc>Self</span>::<span class=n>Target</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=o>&lt;</span><span class=na>&#39;a</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>DerefMut</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>SpinMutexGuard</span><span class=o>&lt;</span><span class=na>&#39;a</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>deref_mut</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=bp>Self</span>::<span class=n>Target</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=nb>Drop</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>SpinMutexGuard</span><span class=o>&lt;</span><span class=nb>&#39;_</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>drop</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>lock</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// usage
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span><span class=w> </span><span class=no>GLOBAL_RESOURCE</span>: <span class=nc>SpinMutex</span><span class=o>&lt;</span><span class=kt>u32</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SpinMutex</span>::<span class=n>new</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>kernel_main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>guard</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>GLOBAL_RESOURCE</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>*</span><span class=n>guard</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// guard is dropped here, and the lock is unlocked
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>هنا، نستخدم <a href=https://doc.rust-lang.org/std/cell/struct.UnsafeCell.html><code>UnsafeCell</code></a> لتخزين البيانات. نقوم بذلك لأننا نرغب في تغيير البيانات حتى إذا كان لدينا وصول مشترك إليها. لذا، يجب أن نخبر المترجم أننا ندرك المخاطر، ولهذا نستخدم <code>unsafe</code>.</p><p>عندما نقوم بقفل ال<code>Mutex</code>، نحصل على <code>SpinMutexGuard</code> الذي يحتوي على مؤشر إلى البيانات. عندما ينتهي، يقوم بفتح القفل. نظرًا لأنه يحتوي على مؤشر إلى القفل داخليًا، نحن واثقون من عدم إمكانية استخدام نواة أخرى للقفل في نفس الوقت. لذا، يمكننا استخدامه بأمان ثم فتحه.</p><p><code>SpinMutexGuard</code> ينفذ <a href=https://doc.rust-lang.org/std/ops/trait.Deref.html><code>Deref</code></a> و <a href=https://doc.rust-lang.org/std/ops/trait.DerefMut.html><code>DerefMut</code></a> لتسهيل الوصول إلى البيانات الداخلية. كما ينفذ أيضًا <a href=https://doc.rust-lang.org/std/ops/trait.Drop.html><code>Drop</code></a> بحيث يتم فتح القفل عندما لا يكون هناك حاجة إليه بعد (مثل عندما يخرج من نطاق الرؤية). يوفر ذلك لنا من الحاجة إلى استدعاء <code>unlock</code> يدويًا (RAII).</p><p>وهذا في الأساس كل شيء، لدينا قفل دوران جيد الآن، ويمكننا استخدامه بسهولة.</p><h2 id=تحسينات-صغيرة-إضافية>تحسينات صغيرة إضافية<a hidden class=anchor aria-hidden=true href=#تحسينات-صغيرة-إضافية>#</a></h2><p>شيء آخر تركته للنهاية، حيث لا يؤثر على الوظائف، ولكنه تحسين جميل.</p><p>وهو استخدام <a href=https://doc.rust-lang.org/core/hint/fn.spin_loop.html><code>core::hint::spin_loop</code></a> بدلاً من حلقة فارغة، وهذا سيوحي للمترجم/وحدة المعالجة المركزية أننا في حالة تكرار، وبالتالي، يمكنها تحسينها بشكل أفضل.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1>1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2>2</a>
</span><span class=hl><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3>3</a>
</span></span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4>4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>fn</span> <span class=nf>lock</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>locked</span><span class=p>.</span><span class=n>compare_exchange</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Acquire</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>Relaxed</span><span class=p>).</span><span class=n>is_err</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>        </span><span class=n>core</span>::<span class=n>hint</span>::<span class=n>spin_loop</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>شيء آخر (شكرًا لـ <code>zypeh</code>) هو استخدام <code>core::sync::atomic::AtomicUsize</code> بدلاً من <code>core::sync::atomic::AtomicBool</code>،
أو باستخدام <a href=https://docs.rs/crossbeam-utils/latest/crossbeam_utils/struct.CachePadded.html><code>crossbeam_utils::CachePadded</code></a> للتأكد من أن القفل ليس في نفس خط التخزين المؤقت للذاكرة الذي يحتوي على متغيرات أخرى.
وبذلك، يمكننا تجنب مشكلة التشارك الكاذبة (false sharing)، وتحسين الأداء.</p><h2 id=المشاكل>المشاكل<a hidden class=anchor aria-hidden=true href=#المشاكل>#</a></h2><p>هذا <code>Mutex</code> الذي لدينا الآن جيد، ولكن هناك عدة قضايا.</p><h3 id=spin>Spin<a hidden class=anchor aria-hidden=true href=#spin>#</a></h3><p>بالطبع، هذا هو قفل دوران، وسيضيع الوقت إذا تم الاحتفاظ بالقفل لفترة طويلة. هناك أنواع أخرى من الأقفال تحاول أن تكون أكثر عدالة، أو تعطي مهمة أخرى للنواة للقيام بها أثناء انتظار القفل. لا أعرف بالضبط، ولكن عندما أقوم بتنفيذ ذلك، سأقوم بإنشاء منشور جديد حوله D:</p><h3 id=another-type-of-deadlock>Another type of deadlock<a hidden class=anchor aria-hidden=true href=#another-type-of-deadlock>#</a></h3><p>تخيل أنك تستخدم قفل داخل نوع <code>Console</code> على سبيل المثال. هذا هو نوع قمت بتنفيذه لطباعة الرسائل على الشاشة/واجهة التسلسل، ستحتاج إلى استخدام قفل هنا بحيث يمكن لنواة واحدة فقط الطباعة في وقت واحد.</p><p>الآن تخيل أن هذا <code>Console</code> يثير استثناء بطريقة ما، ولديك معالج استثناء يقوم بطباعة رسالة الاستثناء. هذا ليس انقطاع تنفيذ لوحدة المعالجة المركزية، ولكنه ميزة في <strong>Rust</strong> تقوم بنقل التنفيذ إلى <code>panic_handler</code> محدد.</p><p>سيؤدي ذلك إلى إنشاء تأخر تشابكي، حيث سيحاول <code>panic_handler</code> قفل <code>Console</code> لطباعة الرسالة، ولكن <code>Console</code> قد تم قفله بالفعل بواسطة النواة التي أثارت الاستثناء، وبالتالي، سنواجه تأخر تشابكي.</p><p>بالنسبة لهذا، يمكنك الاستفادة من نوع خاص من <code>Mutex</code> يسمح لك بقفله مرة أخرى بواسطة نفس النواة فقط. وهذا النوع من القفل يُستخدم فعلاً في المكتبة القياسية داخليًا، ويُسمى <a href=https://doc.rust-lang.org/stable/src/std/sync/remutex.rs.html><code>ReentrantMutex</code></a>. تقوم المكتبة القياسية بتنفيذه مع خيط المالك، ويمكننا ببساطة استبداله بالنواة المالكة .</p><p>ولكن بالطبع، يمكن استخدام هذا النوع فقط في الأماكن القليلة التي تنشأ فيها هذه المشكلة، وليس بشكل عام. وعندما تحصل على القفل مرة أخرى، يجب عليك التأكد من أنك لا تسبب أي مشكلات مع البيانات داخليًا. لن يكون هناك مستخدم آخر في نفس الوقت، ولكن الحالة القابلة للتعديل يجب أن تكون دائمًا صالحة.</p><p>تُستخدم هذه في المكتبة القياسية كغلاف لـ <code>stdout</code> و <code>stderr</code>. (مثال: <a href=https://doc.rust-lang.org/stable/src/std/io/stdio.rs.html#539><code>ReentrantMutex&lt;RefCell&lt;LineWriter&lt;StdoutRaw>>></code></a>)</p><h2 id=الختام-والمراجع>الختام والمراجع<a hidden class=anchor aria-hidden=true href=#الختام-والمراجع>#</a></h2><p>تعتبر <strong>Spinlocks</strong> جزءًا هامًا من أي نظام تشغيل، على الأقل في المرحلة الأولى قبل وجود آليات قفل أفضل، ولذلك من المهم فهم كيفية عملها وكيفية تنفيذها بشكل آمن.</p><p>آمل أن يكون هذا المنشور قد كان مفيدًا، وإذا كان لديك أي أسئلة، يرجى إعلامي.</p><p>كانت هذه التنفيذات مستوحاة بشكل كبير من تنفيذ القفل في <a href=https://github.com/mit-pdos/xv6-public/blob/master/spinlock.c><code>xv6</code></a>، ونوع <a href=https://doc.rust-lang.org/std/sync/struct.Mutex.html><code>Mutex</code></a> في المكتبة القياسية.</p><p>والسلام عليكم ورحمة الله وبركاته</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://amjad.alsharafi.dev/ar/tags/%D9%86%D8%B8%D8%A7%D9%85-%D8%AA%D8%B4%D8%BA%D9%8A%D9%84/>نظام تشغيل</a></li><li><a href=https://amjad.alsharafi.dev/ar/tags/rust/>rust</a></li></ul><nav class=paginav><a class=next href=https://amjad.alsharafi.dev/ar/posts/test/><span class=title>التالي »</span><br><span>تجربه</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share نظام التشغيل - القفل الدوراني on x" href="https://x.com/intent/tweet/?text=%d9%86%d8%b8%d8%a7%d9%85%20%d8%a7%d9%84%d8%aa%d8%b4%d8%ba%d9%8a%d9%84%20-%20%d8%a7%d9%84%d9%82%d9%81%d9%84%20%d8%a7%d9%84%d8%af%d9%88%d8%b1%d8%a7%d9%86%d9%8a&amp;url=https%3a%2f%2famjad.alsharafi.dev%2far%2fposts%2foperating-system%2fspinlocks%2f&amp;hashtags=%d9%86%d8%b8%d8%a7%d9%85%d8%aa%d8%b4%d8%ba%d9%8a%d9%84%2crust"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share نظام التشغيل - القفل الدوراني on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2famjad.alsharafi.dev%2far%2fposts%2foperating-system%2fspinlocks%2f&amp;title=%d9%86%d8%b8%d8%a7%d9%85%20%d8%a7%d9%84%d8%aa%d8%b4%d8%ba%d9%8a%d9%84%20-%20%d8%a7%d9%84%d9%82%d9%81%d9%84%20%d8%a7%d9%84%d8%af%d9%88%d8%b1%d8%a7%d9%86%d9%8a&amp;summary=%d9%86%d8%b8%d8%a7%d9%85%20%d8%a7%d9%84%d8%aa%d8%b4%d8%ba%d9%8a%d9%84%20-%20%d8%a7%d9%84%d9%82%d9%81%d9%84%20%d8%a7%d9%84%d8%af%d9%88%d8%b1%d8%a7%d9%86%d9%8a&amp;source=https%3a%2f%2famjad.alsharafi.dev%2far%2fposts%2foperating-system%2fspinlocks%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share نظام التشغيل - القفل الدوراني on reddit" href="https://reddit.com/submit?url=https%3a%2f%2famjad.alsharafi.dev%2far%2fposts%2foperating-system%2fspinlocks%2f&title=%d9%86%d8%b8%d8%a7%d9%85%20%d8%a7%d9%84%d8%aa%d8%b4%d8%ba%d9%8a%d9%84%20-%20%d8%a7%d9%84%d9%82%d9%81%d9%84%20%d8%a7%d9%84%d8%af%d9%88%d8%b1%d8%a7%d9%86%d9%8a"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share نظام التشغيل - القفل الدوراني on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2famjad.alsharafi.dev%2far%2fposts%2foperating-system%2fspinlocks%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share نظام التشغيل - القفل الدوراني on whatsapp" href="https://api.whatsapp.com/send?text=%d9%86%d8%b8%d8%a7%d9%85%20%d8%a7%d9%84%d8%aa%d8%b4%d8%ba%d9%8a%d9%84%20-%20%d8%a7%d9%84%d9%82%d9%81%d9%84%20%d8%a7%d9%84%d8%af%d9%88%d8%b1%d8%a7%d9%86%d9%8a%20-%20https%3a%2f%2famjad.alsharafi.dev%2far%2fposts%2foperating-system%2fspinlocks%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share نظام التشغيل - القفل الدوراني on telegram" href="https://telegram.me/share/url?text=%d9%86%d8%b8%d8%a7%d9%85%20%d8%a7%d9%84%d8%aa%d8%b4%d8%ba%d9%8a%d9%84%20-%20%d8%a7%d9%84%d9%82%d9%81%d9%84%20%d8%a7%d9%84%d8%af%d9%88%d8%b1%d8%a7%d9%86%d9%8a&amp;url=https%3a%2f%2famjad.alsharafi.dev%2far%2fposts%2foperating-system%2fspinlocks%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share نظام التشغيل - القفل الدوراني on ycombinator" href="https://news.ycombinator.com/submitlink?t=%d9%86%d8%b8%d8%a7%d9%85%20%d8%a7%d9%84%d8%aa%d8%b4%d8%ba%d9%8a%d9%84%20-%20%d8%a7%d9%84%d9%82%d9%81%d9%84%20%d8%a7%d9%84%d8%af%d9%88%d8%b1%d8%a7%d9%86%d9%8a&u=https%3a%2f%2famjad.alsharafi.dev%2far%2fposts%2foperating-system%2fspinlocks%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://amjad.alsharafi.dev/ar/>أمجد الشرفي</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="نسخ الكود";function s(){t.innerHTML="تم النسخ!",setTimeout(()=>{t.innerHTML="نسخ الكود"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>