<!doctype html><html lang=en class=direction-ltr><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>WGMY2020 - RE - Senang - Amjad Alsharafi</title>
<meta name=keywords content="writeup,wgmy2020,reverse engineering"><meta name=description content="Writeup of the reversing challenge Senang in WGMY2020"><meta name=author content="Amjad"><link rel=canonical href=https://amjad.alsharafi.dev/en/posts/wgmy2020/senang/><link href=https://amjad.alsharafi.dev/assets/css/stylesheet.min.fce3746afa57d6eb2c2e93f76c569cf733089396cf5f10c7a659f3b23a65575c.css integrity="sha256-/ON0avpX1ussLpP3bFac9zMIk5bPXxDHplnzsjplV1w=" rel="preload stylesheet" as=style><link rel=apple-touch-icon href=https://amjad.alsharafi.dev/apple-touch-icon.png><link rel=icon href=https://amjad.alsharafi.dev/favicon.ico><meta name=generator content="Hugo 0.120.3"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-N62ZER16LZ","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script><meta property="og:title" content="WGMY2020 - RE - Senang"><meta property="og:description" content="Writeup of the reversing challenge Senang in WGMY2020"><meta property="og:type" content="article"><meta property="og:url" content="https://amjad.alsharafi.dev/en/posts/wgmy2020/senang/"><meta property="article:published_time" content="2020-12-06T07:31:50+03:00"><meta property="article:modified_time" content="2020-12-06T07:31:50+03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="WGMY2020 - RE - Senang"><meta name=twitter:description content="Writeup of the reversing challenge Senang in WGMY2020"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"WGMY2020 - RE - Senang","name":"WGMY2020 - RE - Senang","description":"Second reverse engineering challenge in WGMY2020","keywords":["writeup","wgmy2020","reverse engineering"],"articleBody":"$ file * senang.exe: PE32 executable (console) Intel 80386, for MS Windows Introduction This time it is a windows executable.\nI’ll be using Ghidra and x64dbg for static and dynamic analysis for this challenge.\nAnalysis After opening the file in Ghidra, we can start by searching for the main function in the left panel. This time the main function is not found.\nThere are many methods to find the main function, I’ll find it using strings. When looking in the strings stored in the binary in Ghidra, we can see interesting strings like \"Welcome to WGMY 2020 - senang\", \"Enter flag : \", \"Tahniah !!! Sila submit flag ;)\", and \"Nope, tak betul. Sila jaga jarak sosial ok.\\n\".\nWhen looking at the function referencing these strings, we found the function FUN_00401000, which looks like the main.\nmain analysis void FUN_00401000(void) { int iVar1; int local_6c [25]; uint local_8; local_8 = DAT_004200ec ^ (uint)\u0026stack0xfffffffc; FUN_00403400(local_6c,0,100); FUN_004012e0((int)s_Welcome_to_WGMY_2020_-_senang_0042001c); FUN_004012e0((int)s_Enter_flag_:_0042003c); FUN_00401320((int)\u0026DAT_0042004c); iVar1 = FUN_00401090(local_6c); if (iVar1 == 0) { FUN_004012e0((int)s_Nope,_tak_betul._Sila_jaga_jarak_00420070); } else { FUN_004012e0((int)s_Tahniah_!!!_Sila_submit_flag_;)_00420050); } FUN_004028b3(); return; } There are so many unknown functions, but we can guess what they do, like FUN_004012e0 seems to deal with strings always and looks like its printing them, so we can rename it to print for example.\nThe part below, which is after printing \"Enter flag: \", maybe it can be getting input, and we can confirm this by looking at DAT_0042004c, which is \"%s\".\nFUN_00401320((int)\u0026DAT_0042004c); Ghidra in this case didn’t detect the second argument for the buffer of the string, but if we force it:\nFUN_00401320((int)\u0026DAT_0042004c,local_6c); local_6c is a 26 character buffer, so that checks out. Now we can rename FUN_00401320 to scan.\nFinally, the function FUN_00401090 is being called with the buffer for checking.\nFUN_00401090 analysis Ghidra makes param1 of type int* but we know its not true,so for easier analysis, let’s convert it to char*.\nvoid FUN_00401090(char *param_1) { int iVar1; uint local_80; uint local_7c [26]; undefined4 *local_14; local_14 = (undefined4 *)0x0; if (((*(int *)param_1 == 0x796d6777) \u0026\u0026 (param_1[4] == '{')) \u0026\u0026 (param_1[0x25] == '}')) { FUN_004013a0(local_7c); FUN_00401420(local_7c,PTR_s_Kuehtiow_was_here_?_00420000,DAT_00420018); FUN_004015b0(local_7c); local_80 = 0; while (local_80 \u003c 0x10) { FUN_00401360(\u0026local_14,(int)\u0026DAT_004200a0); iVar1 = _strncmp((char *)\u0026local_14,param_1 + local_80 * 2 + 5,2); if (iVar1 != 0) break; local_80 = local_80 + 1; } } FUN_004028b3(); return; } The function first checks for the wgmy{} part in the flag in:\nif (((*(int *)param_1 == 0x796d6777) \u0026\u0026 (param_1[4] == '{')) \u0026\u0026 (param_1[0x25] == '}')) { 0x796d6777 is wgmy. { at index 4 and } at index 0x25, now we know the middle part is 0x20(32) characters long, and it is checked next.\nLooks like FUN_004013a0(local_7c); fills the buffer local_7c with some values, I don’t know what it represents. FUN_00401420 and FUN_004015b0 seems to do some transformation for the buffer. I’ll come back to this in a bit as it is complex.\nFinally, comparison:\nwhile (counter \u003c 0x10) { FUN_00401360(\u0026local_14,(int)\u0026DAT_004200a0); iVar1 = _strncmp((char *)\u0026local_14,param_1 + counter * 2 + 5,2); if (iVar1 != 0) break; counter = + 1; } I renamed local_80 to counter for easier analysis.\njudging from DAT_004200a0 = \"%02x\" the argument to FUN_00401360, FUN_00401360 looks like sprintf. because the result string at local_14 is being compared to the input string 2 characters at a time. And looks like the correct flag comes from the series of transformations done above.\nWe can analyse the above methods that transforms local_7c buffer statically, but doing it dynamically is much easier, as the local_7c is independent from the input, so we can just look at the arguments of the _strncmp method to find the correct flag.\nDynamic analysis I’ll be using x64dbg in 32-bit mode for this binary. Let’s just run the binary and jump straight to the function FUN_00401090. Looks like the binary has randomization for addresses, so the function will not be at 401090, but the offset is enough, we should go to xxxx1090 (in my case it was 00571090).\nIn the middle we will have to input a flag, so let’s use this\nwgmy{aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa} The call to _strncmp is at 00401176, so let’s make a breakpoint there. When continuing we reach the breakpoint, When looking at the argument stack we find the first 2 characters of the flag to be b4. Now if we continue we will exit the program as b4 does not equal aa, so in order to prevent the jump, we can patch the instruction (as x64dbg enables us to do so) at:\n00401180 JZ LAB_00401186 From JZ to JMP in order to force jump every time as it were equal.\nAfter some loops we get the flag:\nwgmy{b415d7261a3706c43ce852ceeab0e8ac} BUT, when submitting it we get a wrong flag. Looks like there is an anti-debugging method here.\nAnti-debugging break Normally the windows function isDebuggerPresent is used for detecting a debugger in a process, but this method is not being called by this binary. I used another method to get the flag.\nLooks like the anti-debugging is modifying some of the global variables used when transforming local_7c buffer to get the correct flag. If the modification is happening BEFORE taking input we can take advantage of that by attaching the debugger instead of spawning the process from the debugger.\nThe difference between attaching and spawning is that attaching will attach the debugger after the process has started. Before attaching, the process is being run normally without a debugger so anti-debugging methods will not work.\nThe process:\nRun the program without debugger. It should stop when calling scan to take input. Attach the debugger and set a breakpoint in _strncmp to wait for the flag comparison. Continue. Patch the JZ instruction for easier analysis. And wala, we get a different flag this time and it is correct:\nwgmy{f533f9091fc3e8f63191c64cfe1c2157} Note that this method can be prevented by checking for the debugger after input, but maybe the anti-debugging is done before main even? not sure.\n","wordCount":"975","inLanguage":"en","datePublished":"2020-12-06T07:31:50+03:00","dateModified":"2020-12-06T07:31:50+03:00","author":{"@type":"Person","name":"Amjad"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://amjad.alsharafi.dev/en/posts/wgmy2020/senang/"},"publisher":{"@type":"Organization","name":"Amjad Alsharafi","logo":{"@type":"ImageObject","url":"https://amjad.alsharafi.dev/favicon.ico"}}}</script></head><body class=single id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><noscript><style type=text/css>.theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://amjad.alsharafi.dev/en/>Amjad Alsharafi</a>
<span class=logo-switches><span class=theme-toggle><a id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></a></span><span class=lang-switch><span>|</span><ul><li><a href=https://amjad.alsharafi.dev/ar/ title=العربية aria-label=العربية>العربية</a></li></ul></span></span></div><ul class=menu id=menu onscroll=menu_on_scroll()><li><a href=https://amjad.alsharafi.dev/en/about><span>About</span></a></li><li><a href=https://amjad.alsharafi.dev/en/series><span>Series</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>WGMY2020 - RE - Senang</h1><div class=post-meta>December 6, 2020&amp;nbsp;·&amp;nbsp;Amjad</div></header><div class=toc><details open><summary><div class=details>Table of Contents</div></summary><blockquote><ul><li><a href=#introduction>Introduction</a></li><li><a href=#analysis>Analysis</a><ul><li><a href=#main-analysis><code>main</code> analysis</a></li><li><a href=#fun_00401090-analysis><code>FUN_00401090</code> analysis</a></li></ul></li><li><a href=#dynamic-analysis>Dynamic analysis</a><ul><li><a href=#anti-debugging-break>Anti-debugging break</a></li></ul></li></ul></blockquote></details></div><div class=post-content><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ file *
</span></span><span style=display:flex><span>senang.exe:   PE32 executable (console) Intel 80386, for MS Windows
</span></span></code></pre></div><h1 id=introduction>Introduction</h1><p>This time it is a windows executable.</p><p>I&rsquo;ll be using <a href=https://ghidra.re/>Ghidra</a> and <a href=https://x64dbg.com/>x64dbg</a> for static and dynamic analysis for this challenge.</p><h1 id=analysis>Analysis</h1><p>After opening the file in <a href=https://ghidra.re/>Ghidra</a>, we can start by searching for the <code>main</code>
function in the left panel. This time the <code>main</code> function is not found.</p><p>There are many methods to find the <code>main</code> function, I&rsquo;ll find it using strings.
When looking in the strings stored in the binary in <a href=https://ghidra.re/>Ghidra</a>, we can see interesting strings
like <code>"Welcome to WGMY 2020 - senang"</code>, <code>"Enter flag : "</code>, <code>"Tahniah !!! Sila submit flag ;)"</code>,
and <code>"Nope, tak betul. Sila jaga jarak sosial ok.\n"</code>.</p><p>When looking at the function referencing these strings, we found the function <code>FUN_00401000</code>, which
looks like the main.</p><h2 id=main-analysis><code>main</code> analysis</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>FUN_00401000</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> iVar1;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> local_6c [<span style=color:#ae81ff>25</span>];
</span></span><span style=display:flex><span>  uint local_8;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  local_8 <span style=color:#f92672>=</span> DAT_004200ec <span style=color:#f92672>^</span> (uint)<span style=color:#f92672>&amp;</span>stack0xfffffffc;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>FUN_00403400</span>(local_6c,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>FUN_004012e0</span>((<span style=color:#66d9ef>int</span>)s_Welcome_to_WGMY_2020_<span style=color:#f92672>-</span>_senang_0042001c);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>FUN_004012e0</span>((<span style=color:#66d9ef>int</span>)s_Enter_flag_:_0042003c);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>FUN_00401320</span>((<span style=color:#66d9ef>int</span>)<span style=color:#f92672>&amp;</span>DAT_0042004c);
</span></span><span style=display:flex><span>  iVar1 <span style=color:#f92672>=</span> <span style=color:#a6e22e>FUN_00401090</span>(local_6c);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (iVar1 <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>FUN_004012e0</span>((<span style=color:#66d9ef>int</span>)s_Nope,_tak_betul._Sila_jaga_jarak_00420070);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>FUN_004012e0</span>((<span style=color:#66d9ef>int</span>)s_Tahniah_<span style=color:#f92672>!!!</span>_Sila_submit_flag_;)_00420050);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>FUN_004028b3</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>There are so many unknown functions, but we can guess what they do, like
<code>FUN_004012e0</code> seems to deal with strings always and looks like its printing them, so we
can rename it to <code>print</code> for example.</p><p>The part below, which is after printing <code>"Enter flag: "</code>, maybe it can be getting input, and we can confirm this
by looking at <code>DAT_0042004c</code>, which is <code>"%s"</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#a6e22e>FUN_00401320</span>((<span style=color:#66d9ef>int</span>)<span style=color:#f92672>&amp;</span>DAT_0042004c);
</span></span></code></pre></div><p><a href=https://ghidra.re/>Ghidra</a> in this case didn&rsquo;t detect the second argument for the buffer of the string, but if we force it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#a6e22e>FUN_00401320</span>((<span style=color:#66d9ef>int</span>)<span style=color:#f92672>&amp;</span>DAT_0042004c,local_6c);
</span></span></code></pre></div><p><code>local_6c</code> is a <strong>26</strong> character buffer, so that checks out. Now we can rename <code>FUN_00401320</code> to <code>scan</code>.</p><p>Finally, the function <code>FUN_00401090</code> is being called with the buffer for checking.</p><h2 id=fun_00401090-analysis><code>FUN_00401090</code> analysis</h2><p><a href=https://ghidra.re/>Ghidra</a> makes <code>param1</code> of type <code>int*</code> but we know its not true,so for easier analysis,
let&rsquo;s convert it to <code>char*</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>FUN_00401090</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>param_1)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> iVar1;
</span></span><span style=display:flex><span>  uint local_80;
</span></span><span style=display:flex><span>  uint local_7c [<span style=color:#ae81ff>26</span>];
</span></span><span style=display:flex><span>  undefined4 <span style=color:#f92672>*</span>local_14;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  local_14 <span style=color:#f92672>=</span> (undefined4 <span style=color:#f92672>*</span>)<span style=color:#ae81ff>0x0</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (((<span style=color:#f92672>*</span>(<span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>)param_1 <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x796d6777</span>) <span style=color:#f92672>&amp;&amp;</span> (param_1[<span style=color:#ae81ff>4</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;{&#39;</span>)) <span style=color:#f92672>&amp;&amp;</span> (param_1[<span style=color:#ae81ff>0x25</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;}&#39;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>FUN_004013a0</span>(local_7c);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>FUN_00401420</span>(local_7c,PTR_s_Kuehtiow_was_here_<span style=color:#f92672>?</span>_00420000,DAT_00420018);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>FUN_004015b0</span>(local_7c);
</span></span><span style=display:flex><span>    local_80 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (local_80 <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0x10</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>FUN_00401360</span>(<span style=color:#f92672>&amp;</span>local_14,(<span style=color:#66d9ef>int</span>)<span style=color:#f92672>&amp;</span>DAT_004200a0);
</span></span><span style=display:flex><span>      iVar1 <span style=color:#f92672>=</span> <span style=color:#a6e22e>_strncmp</span>((<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>local_14,param_1 <span style=color:#f92672>+</span> local_80 <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>,<span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (iVar1 <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      local_80 <span style=color:#f92672>=</span> local_80 <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>FUN_004028b3</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The function first checks for the <code>wgmy{}</code> part in the flag in:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>if</span> (((<span style=color:#f92672>*</span>(<span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>)param_1 <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x796d6777</span>) <span style=color:#f92672>&amp;&amp;</span> (param_1[<span style=color:#ae81ff>4</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;{&#39;</span>)) <span style=color:#f92672>&amp;&amp;</span> (param_1[<span style=color:#ae81ff>0x25</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;}&#39;</span>)) {
</span></span></code></pre></div><p><code>0x796d6777</code> is <code>wgmy</code>. <code>{</code> at index <strong>4</strong> and <code>}</code> at index <strong>0x25</strong>, now we know the middle part is <strong>0x20(32)</strong> characters
long, and it is checked next.</p><p>Looks like <code>FUN_004013a0(local_7c);</code> fills the buffer <code>local_7c</code> with some values, I don&rsquo;t know what it represents.
<code>FUN_00401420</code> and <code>FUN_004015b0</code> seems to do some transformation for the buffer. I&rsquo;ll come back to this in a bit as it is complex.</p><p>Finally, comparison:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>while</span> (counter <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0x10</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>FUN_00401360</span>(<span style=color:#f92672>&amp;</span>local_14,(<span style=color:#66d9ef>int</span>)<span style=color:#f92672>&amp;</span>DAT_004200a0);
</span></span><span style=display:flex><span>    iVar1 <span style=color:#f92672>=</span> <span style=color:#a6e22e>_strncmp</span>((<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>local_14,param_1 <span style=color:#f92672>+</span> counter <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>,<span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (iVar1 <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    counter <span style=color:#f92672>=</span>  <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I renamed <code>local_80</code> to <code>counter</code> for easier analysis.</p><p>judging from <code>DAT_004200a0</code> = <code>"%02x"</code> the argument to <code>FUN_00401360</code>, <code>FUN_00401360</code> looks like <code>sprintf</code>. because the result string
at <code>local_14</code> is being compared to the input string <strong>2</strong> characters at a time. And looks like the correct flag comes from the series
of transformations done above.</p><p>We can analyse the above methods that transforms <code>local_7c</code> buffer statically, but doing it dynamically is much easier,
as the <code>local_7c</code> is independent from the input, so we can just look at the arguments of the <code>_strncmp</code> method to find the correct flag.</p><h1 id=dynamic-analysis>Dynamic analysis</h1><p>I&rsquo;ll be using <a href=https://x64dbg.com/>x64dbg</a> in <code>32-bit</code> mode for this binary. Let&rsquo;s just run the binary and jump straight to the function
<code>FUN_00401090</code>. Looks like the binary has randomization for addresses, so the function will not be at <code>401090</code>, but the offset
is enough, we should go to <code>xxxx1090</code> (in my case it was <code>00571090</code>).</p><p>In the middle we will have to input a flag, so let&rsquo;s use this</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>wgmy{aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa}
</span></span></code></pre></div><p>The call to <code>_strncmp</code> is at <code>00401176</code>, so let&rsquo;s make a breakpoint there. When continuing we reach the breakpoint,
When looking at the argument stack we find the first 2 characters of the flag to be <code>b4</code>. Now if we continue we will exit the
program as <code>b4</code> does not equal <code>aa</code>, so in order to prevent the <code>jump</code>, we can patch the instruction
(as <a href=https://x64dbg.com/>x64dbg</a> enables us to do so) at:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>00401180  JZ LAB_00401186
</span></span></code></pre></div><p>From <code>JZ</code> to <code>JMP</code> in order to force jump every time as it were equal.</p><p>After some loops we get the flag:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>wgmy{b415d7261a3706c43ce852ceeab0e8ac}
</span></span></code></pre></div><p><strong>BUT</strong>, when submitting it we get a wrong flag. Looks like there is an <em>anti-debugging</em> method here.</p><h2 id=anti-debugging-break>Anti-debugging break</h2><p>Normally the windows function <code>isDebuggerPresent</code> is used for detecting a debugger in a process, but this method
is not being called by this binary. I used another method to get the flag.</p><p>Looks like the anti-debugging is modifying some of the global variables used when transforming <code>local_7c</code> buffer
to get the correct flag. If the modification is happening <strong>BEFORE</strong> taking input we can take advantage of that by
<em>attaching</em> the debugger instead of spawning the process from the debugger.</p><p>The difference between <em>attaching</em> and <em>spawning</em> is that attaching will attach the debugger after the process has
started. Before attaching, the process is being run normally without a debugger so anti-debugging methods will not work.</p><p>The process:</p><ol><li>Run the program without debugger. It should stop when calling <code>scan</code> to take input.</li><li>Attach the debugger and set a breakpoint in <code>_strncmp</code> to wait for the flag comparison.</li><li>Continue.</li><li>Patch the <code>JZ</code> instruction for easier analysis.</li></ol><p>And wala, we get a different flag this time and it is correct:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>wgmy{f533f9091fc3e8f63191c64cfe1c2157}
</span></span></code></pre></div><blockquote><p>Note that this method can be prevented by checking for the debugger after input, but maybe the anti-debugging
is done before <code>main</code> even? not sure.</p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://amjad.alsharafi.dev/en/tags/writeup>writeup</a></li><li><a href=https://amjad.alsharafi.dev/en/tags/wgmy2020>wgmy2020</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share WGMY2020 - RE - Senang on twitter" href="https://twitter.com/intent/tweet/?text=WGMY2020%20-%20RE%20-%20Senang&amp;url=https%3a%2f%2famjad.alsharafi.dev%2fen%2fposts%2fwgmy2020%2fsenang%2f&amp;hashtags=writeup%2cwgmy2020"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share WGMY2020 - RE - Senang on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2famjad.alsharafi.dev%2fen%2fposts%2fwgmy2020%2fsenang%2f&amp;title=WGMY2020%20-%20RE%20-%20Senang&amp;summary=WGMY2020%20-%20RE%20-%20Senang&amp;source=https%3a%2f%2famjad.alsharafi.dev%2fen%2fposts%2fwgmy2020%2fsenang%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share WGMY2020 - RE - Senang on reddit" href="https://reddit.com/submit?url=https%3a%2f%2famjad.alsharafi.dev%2fen%2fposts%2fwgmy2020%2fsenang%2f&title=WGMY2020%20-%20RE%20-%20Senang"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share WGMY2020 - RE - Senang on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2famjad.alsharafi.dev%2fen%2fposts%2fwgmy2020%2fsenang%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share WGMY2020 - RE - Senang on whatsapp" href="https://api.whatsapp.com/send?text=WGMY2020%20-%20RE%20-%20Senang%20-%20https%3a%2f%2famjad.alsharafi.dev%2fen%2fposts%2fwgmy2020%2fsenang%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share WGMY2020 - RE - Senang on telegram" href="https://telegram.me/share/url?text=WGMY2020%20-%20RE%20-%20Senang&amp;url=https%3a%2f%2famjad.alsharafi.dev%2fen%2fposts%2fwgmy2020%2fsenang%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://amjad.alsharafi.dev/en/>Amjad Alsharafi</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo️️</a>️</span>
<span>&#183;</span>
<span>Theme️ <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top"><button class=top-link id=top-link type=button>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6"><path d="M12 6H0l6-6z"/></svg></button>
</a><script src=https://amjad.alsharafi.dev/assets/js/highlight.min.c3ba6b72cb9e7e277941c68cf93ddb7934b56c911c142c959587a4135585740f.js integrity="sha256-w7prcsuefid5QcaM+T3beTS1bJEcFCyVlYekE1WFdA8="></script><script>hljs.initHighlightingOnLoad()</script><script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById("menu").scrollLeft=localStorage.getItem("menu-scroll-position"))},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault(),document.querySelector(this.getAttribute("href")).scrollIntoView({behavior:"smooth"})})});var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById("menu").scrollLeft)}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>